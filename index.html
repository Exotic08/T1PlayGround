<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minesweeper Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. SETTINGS & VARIABLES --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-panel: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #3b82f6;
            --accent: #10b981;
            --danger: #f43f5e;
            --gold: #fbbf24;
            --text: #f8fafc;
            --font-main: 'Nunito', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- 2. SCREEN SYSTEM --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding-top: 80px;
            opacity: 0; pointer-events: none; transition: all 0.4s ease;
            z-index: 1;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 10; }

        /* --- 3. UI COMPONENTS --- */
        .user-badge {
            position: absolute; top: 15px; right: 15px; z-index: 100;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            padding: 8px 16px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 700;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none; align-items: center; gap: 8px;
            cursor: pointer; transition: background 0.2s;
        }
        .user-badge:hover { background: rgba(59, 130, 246, 0.3); border-color: var(--primary); }
        .edit-icon { font-size: 0.8rem; opacity: 0.7; margin-left: 5px; }

        h1 {
            font-size: 2.2rem; margin-bottom: 1.5rem;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 2px; font-weight: 900;
        }

        .btn {
            background: var(--glass-panel);
            color: white; border: 1px solid var(--glass-border);
            padding: 15px 25px; margin: 10px; border-radius: 16px;
            font-size: 1.1rem; font-weight: 700;
            cursor: pointer; width: 85%; max-width: 320px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s, background 0.2s;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); border: none; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-danger { background: rgba(244, 63, 94, 0.2); border-color: var(--danger); color: var(--danger); }

        .input-group { width: 85%; max-width: 320px; margin-bottom: 20px; }
        input {
            width: 100%; padding: 14px; border-radius: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            color: white; font-size: 1.1rem; text-align: center;
            outline: none; transition: border 0.3s;
            margin-bottom: 10px;
        }
        input:focus { border-color: var(--primary); }
        .input-label { font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px; display: block; text-align: left; margin-left: 5px;}

        /* --- 4. GAME BOARD --- */
        .game-header { width: 95vw; max-width: 420px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .pc-switch { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--glass-border); cursor: pointer; }
        .pc-dot { width: 12px; height: 12px; border-radius: 50%; background: #64748b; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: background 0.3s; }
        .pc-switch.on .pc-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
        .pc-text { font-size: 0.85rem; font-weight: 700; color: #94a3b8; }
        .pc-switch.on .pc-text { color: white; }

        .board-wrap { position: relative; background: rgba(30, 41, 59, 0.5); padding: 8px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px); border: 1px solid var(--glass-border); }
        .grid { display: grid; gap: 4px; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); width: 90vw; max-width: 380px; aspect-ratio: 1/1; }

        .cell { background: rgba(255, 255, 255, 0.1); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 18px; transition: all 0.1s; box-shadow: inset 0 2px 4px rgba(255,255,255,0.05), 0 2px 2px rgba(0,0,0,0.2); }
        .cell:active { transform: scale(0.9); }
        .cell.revealed { background: rgba(0, 0, 0, 0.2); box-shadow: none; cursor: default; }
        .cell.bomb { background: var(--danger); animation: shake 0.4s; }
        .cell.chord-error { animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .c1{color:#60a5fa} .c2{color:#4ade80} .c3{color:#f87171} .c4{color:#c084fc} .c5{color:#fbbf24} .c6{color:#2dd4bf} .c7{color:#000000} .c8{color:#808080}

        .controls { width: 95vw; max-width: 400px; display: flex; gap: 12px; margin-top: 20px; transition: opacity 0.3s; }
        .mode-btn { flex: 1; padding: 18px; border-radius: 16px; border: none; background: rgba(255,255,255,0.05); color: #94a3b8; font-weight: 800; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transform: translateY(-2px); }
        .mode-btn.active.flag { background: var(--danger); box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
        
        .pc-hint { display: none; margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; color: #cbd5e1; font-size: 0.95rem; text-align: center; }

        /* --- 5. LEADERBOARD --- */
        .lb-tabs { display: flex; gap: 5px; margin-bottom: 15px; width: 95%; max-width: 420px; }
        .tab-btn { flex: 1; padding: 10px 5px; background: transparent; border: 1px solid var(--glass-border); color: #94a3b8; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem;}
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .lb-list { list-style: none; padding: 0; margin: 0; width: 95%; max-width: 420px; max-height: 55vh; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 16px; }
        .lb-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lb-rank { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.1); font-weight: bold; font-size: 0.9rem; margin-right: 12px; flex-shrink: 0;}
        .lb-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; margin-right: 10px; }
        .lb-name { font-weight: 700; color: white; font-size: 1rem; line-height: 1.2; }
        .lb-desc { font-size: 0.8rem; color: #94a3b8; font-style: italic; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;}
        
        .lb-stats { text-align: right; display: flex; flex-direction: column; align-items: flex-end;}
        .lb-val { font-weight: 800; color: var(--accent); font-size: 1rem;}
        .lb-sub { font-size: 0.75rem; color: #94a3b8; margin-top: 2px;}

        .lb-top1 .lb-rank { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); }
        .lb-top2 .lb-rank { background: #e2e8f0; color: #000; }
        .lb-top3 .lb-rank { background: #d97706; color: #fff; }
        
        /* VERSION DISPLAY */
        .version-tag { position: absolute; bottom: 10px; right: 10px; color: rgba(255,255,255,0.2); font-size: 0.8rem; pointer-events: none;}

        /* --- 6. OVERLAY --- */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .overlay.show { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div id="user-badge" class="user-badge" onclick="App.editProfile()">
        <span>üë§ <span id="u-name">...</span></span>
        <span class="edit-icon">‚úèÔ∏è</span>
    </div>

    <div id="screen-name" class="screen active" style="justify-content: center; padding-top: 0;">
        <h1>B∆Ø·ªöC 1/2</h1>
        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--glass-border);">
            <div class="input-group">
                <span class="input-label">T√™n ƒë·∫°i di·ªán (ID):</span>
                <input type="text" id="inp-name" placeholder="V√≠ d·ª•: ProGamer" maxlength="12">
            </div>
            <button class="btn btn-primary" id="btn-next" style="width: 100%; margin: 10px 0;">TI·∫æP T·ª§C ‚û°Ô∏è</button>
            <p id="name-msg" style="margin-top: 15px; font-size: 0.9rem; color: var(--accent); min-height: 20px;"></p>
        </div>
    </div>

    <div id="screen-slogan" class="screen" style="justify-content: center; padding-top: 0;">
        <h1>B∆Ø·ªöC 2/2</h1>
        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--glass-border);">
            <h3 id="welcome-user" style="margin: 0 0 20px 0; color: var(--primary);">Xin ch√†o!</h3>
            <div class="input-group">
                <span class="input-label">M√¥ t·∫£ / Slogan (T√πy ch·ªçn):</span>
                <input type="text" id="inp-desc" placeholder="V√≠ d·ª•: B·∫•t b·∫°i!" maxlength="25">
            </div>
            <button class="btn btn-primary" id="btn-finish" style="width: 100%; margin: 10px 0;">HO√ÄN T·∫§T ‚úÖ</button>
        </div>
    </div>

    <div id="screen-menu" class="screen" style="justify-content: center; padding-top: 0;">
        <h1 style="font-size: 2.5rem;">MENU</h1>
        <button class="btn btn-primary" onclick="App.play()">üéÆ CH∆†I NGAY</button>
        <button class="btn" onclick="App.leaderboard('wins')">üèÜ B·∫¢NG X·∫æP H·∫†NG</button>
        <div class="version-tag">Ver: 2.2 (Fix Rank)</div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="btn-icon" onclick="App.nav('menu')">‚¨Ö</button>
            <div id="pc-switch" class="pc-switch" onclick="Game.togglePC()">
                <div class="pc-dot"></div><span class="pc-text">PC MODE</span>
            </div>
        </div>
        <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 1.3rem; font-weight: 800;">
            <div style="background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 12px;">üö© <span id="g-flags">0</span></div>
            <div style="background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 12px;">‚è±Ô∏è <span id="g-time">0</span>s</div>
        </div>
        <div class="board-wrap">
            <div id="grid" class="grid"></div>
            <div id="overlay" class="overlay">
                <h1 id="res-title" style="font-size: 3rem; margin-bottom: 10px;">TH·∫ÆNG!</h1>
                <p id="res-sub" style="font-size: 1.2rem; color: #cbd5e1; margin-bottom: 30px;"></p>
                <button class="btn btn-primary" onclick="Game.init()">Ch∆°i L·∫°i</button>
                <button class="btn" onclick="App.nav('menu')">V·ªÅ Menu</button>
            </div>
        </div>
        <div id="mob-ctrl" class="controls">
            <button id="btn-dig" class="mode-btn active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
            <button id="btn-flag" class="mode-btn flag" onclick="Game.setMode('flag')">üö© C·∫ÆM C·ªú</button>
        </div>
        <div id="pc-hint" class="pc-hint">
            <div>üñ±Ô∏è <b>Chu·ªôt Tr√°i:</b> ƒê√†o</div>
            <div>üñ±Ô∏è <b>Chu·ªôt Ph·∫£i:</b> C·∫Øm c·ªù</div>
            <div style="margin-top:5px; color: var(--accent)">üí° <b>M·∫πo:</b> Click v√†o s·ªë ƒë·ªÉ m·ªü nhanh (Chord)</div>
        </div>
    </div>

    <div id="screen-lb" class="screen">
        <div class="game-header" style="justify-content: flex-start; gap: 15px;">
            <button class="btn-icon" onclick="App.nav('menu')">‚¨Ö</button>
            <h2 style="margin:0; color: white;">X·∫æP H·∫†NG</h2>
        </div>
        <div class="lb-tabs">
            <button id="tab-wins" class="tab-btn active" onclick="App.leaderboard('wins')">üèÜ CHI·∫æN TH·∫ÆNG</button>
            <button id="tab-time" class="tab-btn" onclick="App.leaderboard('time')">‚ö° T·ªêC ƒê·ªò</button>
            <button id="tab-rate" class="tab-btn" onclick="App.leaderboard('rate')">üìà T·ªà L·ªÜ</button>
        </div>
        <ul id="lb-list" class="lb-list"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) { registration.unregister(); }
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDXn3IK3Td2WyegZkU0m1hESQQSRLM1Zb8",
            authDomain: "minesweeper-a7423.firebaseapp.com",
            databaseURL: "https://minesweeper-a7423-default-rtdb.firebaseio.com",
            projectId: "minesweeper-a7423",
            storageBucket: "minesweeper-a7423.firebasestorage.app",
            messagingSenderId: "305681879682",
            appId: "1:305681879682:web:31f1a90362b20b06cbda9b",
            measurementId: "G-XBJQF7Q242"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db);

        const State = {
            user: null,
            data: { wins: 0, losses: 0, bestTime: 999999, desc: "" },
            currentTab: 'wins'
        };

        window.App = {
            nav: (screen) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-' + screen).classList.add('active');
            },

            submitName: async () => {
                const btn = document.getElementById('btn-next');
                const msg = document.getElementById('name-msg');
                const inp = document.getElementById('inp-name');
                let name = inp.value.trim().replace(/[^a-zA-Z0-9 ]/g, "");

                if (name.length < 2) return alert("T√™n qu√° ng·∫Øn!");
                
                btn.disabled = true; msg.innerText = "Ki·ªÉm tra d·ªØ li·ªáu...";

                try {
                    const snapshot = await get(child(dbRef, `users/${name}`));
                    State.user = name;

                    if (snapshot.exists()) {
                        let val = snapshot.val();
                        if (typeof val === 'number') val = { wins: val, losses: 0, bestTime: 999999, desc: "" };
                        if (typeof val.losses === 'undefined') val.losses = 0;
                        State.data = val;
                        document.getElementById('inp-desc').value = val.desc || "";
                    } else {
                        State.data = { wins: 0, losses: 0, bestTime: 999999, desc: "" };
                        document.getElementById('inp-desc').value = "";
                    }
                    document.getElementById('welcome-user').innerText = `Xin ch√†o, ${name}!`;
                    App.nav('slogan');
                } catch (e) { console.error(e); msg.innerText = "L·ªói m·∫°ng!"; }
                btn.disabled = false;
            },

            submitSlogan: async () => {
                const btn = document.getElementById('btn-finish');
                const desc = document.getElementById('inp-desc').value.trim();
                btn.disabled = true; State.data.desc = desc;
                try {
                    const updates = {}; updates[`/users/${State.user}`] = State.data;
                    await update(dbRef, updates);
                    document.getElementById('u-name').innerText = State.user;
                    document.getElementById('user-badge').style.display = 'flex';
                    App.nav('menu');
                } catch(e) { alert("L·ªói l∆∞u d·ªØ li·ªáu!"); }
                btn.disabled = false;
            },

            editProfile: () => {
                if(!State.user) return;
                document.getElementById('inp-name').value = State.user;
                App.nav('name');
            },

            play: () => { App.nav('game'); Game.init(); },

            leaderboard: async (type) => {
                State.currentTab = type; App.nav('lb');
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + type).classList.add('active');

                const list = document.getElementById('lb-list');
                list.innerHTML = '<li style="padding:20px; text-align:center; color:#94a3b8;">ƒêang t·∫£i...</li>';

                try {
                    const snapshot = await get(child(dbRef, 'users'));
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        let arr = [];
                        
                        Object.keys(users).forEach(key => {
                            let u = users[key];
                            if (typeof u === 'number') u = { wins: u, losses: 0, bestTime: 999999, desc: "" };
                            if (typeof u.losses === 'undefined') u.losses = 0;
                            
                            // LOGIC M·ªöI: Ch·ªâ th√™m v√†o n·∫øu ƒë√£ ch∆°i √≠t nh·∫•t 1 tr·∫≠n (Th·∫Øng ho·∫∑c Thua)
                            let totalGames = (u.wins || 0) + (u.losses || 0);
                            if (totalGames === 0) return; 

                            if (type === 'time' && (!u.bestTime || u.bestTime >= 999999)) return;
                            arr.push({ name: key, ...u });
                        });

                        if (type === 'wins') arr.sort((a, b) => b.wins - a.wins);
                        else if (type === 'time') arr.sort((a, b) => a.bestTime - b.bestTime);
                        else if (type === 'rate') {
                            arr.sort((a, b) => {
                                const tA = a.wins + a.losses, tB = b.wins + b.losses;
                                const rA = tA === 0 ? 0 : a.wins / tA;
                                const rB = tB === 0 ? 0 : b.wins / tB;
                                if (rB !== rA) return rB - rA; return b.wins - a.wins;
                            });
                        }

                        list.innerHTML = '';
                        if (arr.length === 0) list.innerHTML = '<li style="padding:20px; text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</li>';

                        arr.forEach((u, i) => {
                            let rankClass = i < 3 ? `lb-top${i+1}` : '';
                            let userDesc = u.desc || "Kh√¥ng c√≥ m√¥ t·∫£";
                            let totalGames = (u.wins || 0) + (u.losses || 0);
                            let winRate = totalGames === 0 ? 0 : ((u.wins / totalGames) * 100).toFixed(1);
                            let valDisplay = '', subDisplay = '';

                            if (type === 'wins') { valDisplay = `${u.wins} Win`; subDisplay = `${winRate}%`; }
                            else if (type === 'time') { valDisplay = `${u.bestTime}s`; subDisplay = "K·ª∑ l·ª•c"; }
                            else if (type === 'rate') { valDisplay = `${winRate}%`; subDisplay = `${u.wins}T / ${totalGames}Tr·∫≠n`; }

                            list.innerHTML += `<li class="lb-item ${rankClass}" style="${u.name === State.user ? 'background:rgba(59,130,246,0.15)' : ''}"><div class="lb-rank">${i+1}</div><div class="lb-info"><div class="lb-name">${u.name}</div><div class="lb-desc">${userDesc}</div></div><div class="lb-stats"><div class="lb-val">${valDisplay}</div><div class="lb-sub">${subDisplay}</div></div></li>`;
                        });
                    }
                } catch (e) { list.innerHTML = 'L·ªói t·∫£i'; }
            },

            saveResult: async (time) => {
                if (!State.user) return;
                State.data.wins++;
                let isRecord = false;
                if (time < State.data.bestTime) { State.data.bestTime = time; isRecord = true; }
                const updates = {}; updates[`/users/${State.user}`] = State.data;
                await update(dbRef, updates);
                return isRecord;
            },

            recordLoss: async () => {
                if (!State.user) return;
                if (typeof State.data.losses === 'undefined') State.data.losses = 0;
                State.data.losses++;
                const updates = {}; updates[`/users/${State.user}`] = State.data;
                await update(dbRef, updates);
            }
        };

        document.getElementById('btn-next').onclick = App.submitName;
        document.getElementById('btn-finish').onclick = App.submitSlogan;

        window.Game = {
            cfg: { w: 10, bombs: 15 }, grid: [], dom: [],
            state: { over: false, first: true, flags: 0, revealed: 0, mode: 'dig', time: 0, timer: null, isPC: false },
            init: () => {
                const gridEl = document.getElementById('grid');
                gridEl.innerHTML = ''; Game.dom = []; Game.grid = new Array(100).fill(0);
                let pc = Game.state.isPC;
                Game.state = { over: false, first: true, flags: 0, revealed: 0, mode: 'dig', time: 0, timer: null, isPC: pc };
                document.getElementById('overlay').classList.remove('show');
                Game.updateHUD(); clearInterval(Game.state.timer);
                document.getElementById('g-time').innerText = '0';
                Game.setMode('dig');
                const frag = document.createDocumentFragment();
                for(let i=0; i<100; i++){
                    const cell = document.createElement('div'); cell.className = 'cell';
                    cell.onclick = () => Game.click(i); cell.oncontextmenu = (e) => { e.preventDefault(); Game.toggleFlag(i); };
                    frag.appendChild(cell); Game.dom.push(cell);
                }
                gridEl.appendChild(frag);
            },
            togglePC: () => {
                Game.state.isPC = !Game.state.isPC;
                const sw = document.getElementById('pc-switch'); const mobCtrl = document.getElementById('mob-ctrl'); const pcHint = document.getElementById('pc-hint');
                if (Game.state.isPC) { sw.classList.add('on'); mobCtrl.style.display = 'none'; mobCtrl.style.opacity = '0'; pcHint.style.display = 'block'; } 
                else { sw.classList.remove('on'); mobCtrl.style.display = 'flex'; setTimeout(()=> mobCtrl.style.opacity = '1', 10); pcHint.style.display = 'none'; }
            },
            setMode: (m) => {
                Game.state.mode = m;
                document.getElementById('btn-dig').className = `mode-btn ${m==='dig'?'active':''}`;
                document.getElementById('btn-flag').className = `mode-btn flag ${m==='flag'?'active':''}`;
            },
            updateHUD: () => { document.getElementById('g-flags').innerText = Game.cfg.bombs - Game.state.flags; },
            
            click: (i) => {
                if(Game.state.over) return;
                const cell = Game.dom[i];
                if(cell.classList.contains('revealed') && Game.grid[i] > 0) { Game.chord(i); return; }
                Game.state.isPC ? Game.dig(i) : (Game.state.mode==='flag'?Game.toggleFlag(i):Game.dig(i)); 
            },

            chord: (i) => {
                const val = Game.grid[i];
                const neighbors = Game.getNeighbors(i);
                const flags = neighbors.filter(n => Game.dom[n].classList.contains('flagged')).length;
                if (flags === val) {
                    Game.vib(20);
                    neighbors.forEach(n => {
                        if (!Game.dom[n].classList.contains('revealed') && !Game.dom[n].classList.contains('flagged')) { Game.dig(n); }
                    });
                } else { Game.dom[i].classList.add('chord-error'); setTimeout(()=>Game.dom[i].classList.remove('chord-error'), 300); }
            },

            toggleFlag: (i) => {
                const c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                if(c.classList.contains('flagged')) { c.classList.remove('flagged'); c.innerText=''; Game.state.flags--; }
                else if(Game.state.flags < Game.cfg.bombs) { c.classList.add('flagged'); c.innerText='üö©'; Game.state.flags++; }
                Game.updateHUD();
            },
            dig: (i) => {
                const c = Game.dom[i]; if(c.classList.contains('flagged')||c.classList.contains('revealed')) return;
                if(Game.state.first) {
                    Game.plant(i); Game.state.first = false;
                    Game.state.timer = setInterval(()=>{Game.state.time++; document.getElementById('g-time').innerText = Game.state.time;}, 1000);
                }
                if(Game.grid[i]==='B') Game.end(false, i);
                else { Game.reveal(i); if(Game.state.revealed===85) Game.end(true); }
            },
            reveal: (i) => {
                const c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                c.classList.add('revealed'); Game.state.revealed++;
                if(Game.grid[i]>0) { c.innerText = Game.grid[i]; c.classList.add('c'+Game.grid[i]); }
                else Game.getNeighbors(i).forEach(n=>Game.reveal(n));
            },
            plant: (s) => {
                let c=0; while(c<15) { let r=Math.floor(Math.random()*100); if(r!==s && Game.grid[r]!=='B') { Game.grid[r]='B'; c++; } }
                for(let i=0; i<100; i++) if(Game.grid[i]!=='B') Game.grid[i] = Game.getNeighbors(i).filter(n=>Game.grid[n]==='B').length;
            },
            getNeighbors: (i) => {
                const w=10, l=i%w===0, r=i%w===w-1;
                return [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1].filter(x=>x>=0&&x<100);
            },
            end: async (w, i) => {
                Game.state.over = true; clearInterval(Game.state.timer);
                Game.grid.forEach((v,x)=>{ if(v==='B' && !Game.dom[x].classList.contains('flagged')) {Game.dom[x].classList.add('revealed','bomb'); Game.dom[x].innerText='üí£';}});
                const t = document.getElementById('res-title'); const s = document.getElementById('res-sub');
                
                if(w) { 
                    t.innerText="CHI·∫æN TH·∫ÆNG!"; t.style.color="#4ade80"; const rec = await App.saveResult(Game.state.time); 
                    s.innerHTML=`Th·ªùi gian: <b>${Game.state.time}s</b>`+(rec?"<br>üöÄ K·ª∂ L·ª§C M·ªöI!":""); 
                } else { 
                    t.innerText="THUA R·ªíI!"; t.style.color="#f43f5e"; 
                    if(i!==undefined) Game.dom[i].style.background="#be123c"; 
                    s.innerText="Th·ª≠ l·∫°i nh√©!";
                    App.recordLoss();
                }
                setTimeout(()=>document.getElementById('overlay').classList.add('show'), 1000);
            },
            vib: (p) => { if(navigator.vibrate) navigator.vibrate(p); }
        };
    </script>
</body>
</html>
