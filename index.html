<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minesweeper Online</title>
    <style>
        /* GI·ªÆ NGUY√äN GIAO DI·ªÜN C≈® V√å ƒê√É T·ªêI ∆ØU */
        :root { --bg-dark: #0f172a; --panel-bg: #1e293b; --primary: #3b82f6; --accent: #10b981; --danger: #ef4444; --text-light: #f1f5f9; --text-dim: #94a3b8; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: var(--text-light); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; touch-action: manipulation; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 20px; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: var(--primary); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-align: center; }
        h2 { color: var(--accent); margin-bottom: 15px; }
        .btn { background: var(--panel-bg); color: var(--text-light); border: 2px solid var(--primary); padding: 14px 24px; margin: 8px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; max-width: 280px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-back { position: absolute; top: 15px; left: 15px; width: auto; padding: 8px 16px; font-size: 0.9rem; z-index: 100; background: rgba(30, 41, 59, 0.8); border: 1px solid var(--text-dim); }
        input { padding: 15px; border-radius: 10px; background: var(--panel-bg); color: white; border: 1px solid var(--text-dim); font-size: 1.1rem; margin-bottom: 20px; text-align: center; width: 100%; max-width: 280px; }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .game-wrapper { width: 95vw; max-width: 400px; background: var(--panel-bg); padding: 8px; border-radius: 12px; display: flex; justify-content: center; align-items: center; aspect-ratio: 1/1; box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; }
        .grid { display: grid; width: 100%; height: 100%; gap: 2px; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); }
        .cell { background: #475569; border-radius: 3px; display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 16px; cursor: pointer; user-select: none; transition: background 0.1s; }
        .cell.revealed { background: #334155; border: 1px solid #1e293b; cursor: default; }
        .cell.flagged { background: #475569; }
        .cell.bomb { background: var(--danger) !important; color: white !important; }
        .cell[data-v="1"] { color: #60a5fa; } .cell[data-v="2"] { color: #4ade80; } .cell[data-v="3"] { color: #f87171; } .cell[data-v="4"] { color: #c084fc; } .cell[data-v="5"] { color: #fbbf24; }
        .header-hud { display: flex; justify-content: space-between; width: 95vw; max-width: 400px; margin-bottom: 15px; font-weight: bold; font-size: 1.2rem; background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 8px; }
        .controls { display: flex; gap: 10px; margin-top: 15px; width: 95vw; max-width: 400px; }
        .mode-btn { flex: 1; padding: 15px; border-radius: 10px; border: none; background: #334155; color: #94a3b8; font-weight: bold; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 0 #1d4ed8; transform: translateY(-2px); }
        .mode-btn.active.flag { background: var(--danger); box-shadow: 0 4px 0 #b91c1c; }
        .mode-btn:active { transform: translateY(0); box-shadow: none !important;}
        .user-bar { position: absolute; top: 0; right: 0; padding: 10px 15px; background: rgba(15, 23, 42, 0.9); font-size: 0.9rem; z-index: 50; border-bottom-left-radius: 10px; font-weight: bold; border-left: 1px solid #334155; border-bottom: 1px solid #334155; }
        .lb-container { width: 100%; max-width: 350px; background: var(--panel-bg); border-radius: 12px; max-height: 60vh; overflow-y: auto; border: 1px solid #334155; }
        .lb-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--bg-dark); }
        .lb-item:last-child { border-bottom: none; }
        .lb-rank { color: var(--text-dim); font-weight: bold; width: 30px;}
        .lb-name { flex: 1; font-weight: bold; }
        .lb-score { color: var(--accent); font-weight: bold; }
        .result-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; border-radius: 12px; animation: fadeIn 0.2s; }
        .result-overlay.show { display: flex; }
        .result-title { font-size: 2rem; margin-bottom: 20px; font-weight: 800; text-align: center;}
    </style>
</head>
<body>

    <div id="user-info" class="user-bar" style="display: none;">
        üë§ <span id="display-name">...</span> | üèÜ <span id="display-wins">...</span>
    </div>

    <div id="screen-login" class="screen active">
        <h1>Minesweeper Online</h1>
        <p style="color: var(--text-dim); margin-bottom: 10px;">D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n m√¢y ‚òÅÔ∏è</p>
        <input type="text" id="username-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="12">
        <button class="btn btn-primary" id="btn-login">B·∫ÆT ƒê·∫¶U üöÄ</button>
        <div id="loading" style="display:none; color: var(--accent); margin-top:10px;">ƒêang k·∫øt n·ªëi server...</div>
    </div>

    <div id="screen-menu" class="screen">
        <h1>MENU</h1>
        <button class="btn btn-primary" onclick="App.switchScreen('game')">üéÆ CH∆†I NGAY</button>
        <button class="btn" onclick="App.showLeaderboard()">üèÜ B·∫¢NG X·∫æP H·∫†NG</button>
        <button class="btn btn-danger" onclick="App.logout()">Tho√°t</button>
    </div>

    <div id="screen-leaderboard" class="screen">
        <button class="btn btn-back" onclick="App.switchScreen('menu')">‚¨Ö Menu</button>
        <h2>TOP SERVER</h2>
        <div class="lb-container">
            <div id="lb-list">Loading...</div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="btn btn-back" onclick="App.switchScreen('menu')">‚¨Ö Tho√°t</button>
        <div class="header-hud">
            <span>üö© <span id="game-flags">0</span></span>
            <span>‚è±Ô∏è <span id="game-timer">0</span></span>
        </div>
        <div class="game-wrapper">
            <div id="grid" class="grid"></div>
            <div id="result-overlay" class="result-overlay">
                <div id="result-msg" class="result-title">TH·∫ÆNG!</div>
                <button class="btn btn-primary" onclick="Game.init()">Ch∆°i L·∫°i</button>
                <button class="btn" onclick="App.switchScreen('menu')" style="margin-top: 10px;">V·ªÅ Menu</button>
            </div>
        </div>
        <div class="controls">
            <button id="btn-dig" class="mode-btn active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
            <button id="btn-flag" class="mode-btn flag" onclick="Game.setMode('flag')">üö© C·ªú</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- C·∫§U H√åNH FIREBASE (B·∫†N PH·∫¢I D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
        const firebaseConfig = {
  apiKey: "AIzaSyDXn3IK3Td2WyegZkU0m1hESQQSRLM1Zb8",
  authDomain: "minesweeper-a7423.firebaseapp.com",
  databaseURL: "https://minesweeper-a7423-default-rtdb.firebaseio.com",
  projectId: "minesweeper-a7423",
  storageBucket: "minesweeper-a7423.firebasestorage.app",
  messagingSenderId: "305681879682",
  appId: "1:305681879682:web:31f1a90362b20b06cbda9b",
  measurementId: "G-XBJQF7Q242"
};

        // Kh·ªüi t·∫°o Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase connected");
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi Firebase. H√£y ki·ªÉm tra config!", e);
        }

        // --- QU·∫¢N L√ù D·ªÆ LI·ªÜU (ƒê√ÅM M√ÇY) ---
        const Cloud = {
            // L·∫•y ƒëi·ªÉm c·ªßa 1 user
            getUser: async (name) => {
                if(!db) return 0;
                const dbRef = ref(db);
                try {
                    const snapshot = await get(child(dbRef, `users/${name}`));
                    if (snapshot.exists()) {
                        return snapshot.val();
                    } else {
                        return 0; // Ch∆∞a ch∆°i bao gi·ªù
                    }
                } catch (error) {
                    console.error(error);
                    return 0;
                }
            },

            // C·∫≠p nh·∫≠t ƒëi·ªÉm
            updateWin: async (name, currentWins) => {
                if(!db) return;
                const newScore = currentWins + 1;
                // C·∫≠p nh·∫≠t l√™n server
                await set(ref(db, 'users/' + name), newScore);
                return newScore;
            },

            // L·∫•y to√†n b·ªô b·∫£ng x·∫øp h·∫°ng
            getAllUsers: async () => {
                if(!db) return {};
                const dbRef = ref(db);
                try {
                    const snapshot = await get(child(dbRef, `users`));
                    if (snapshot.exists()) return snapshot.val();
                    return {};
                } catch (error) { return {}; }
            }
        };

        // --- APP LOGIC (ƒê√£ s·ª≠a ƒë·ªÉ d√πng Cloud) ---
        window.App = {
            currentUser: null,
            currentWins: 0,

            login: async () => {
                const input = document.getElementById('username-input');
                const name = input.value.trim().replace(/[.#$\[\]]/g, ""); // Firebase kh√¥ng th√≠ch k√Ω t·ª± ƒë·∫∑c bi·ªát
                
                if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
                
                document.getElementById('btn-login').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // L·∫•y d·ªØ li·ªáu t·ª´ Cloud
                const wins = await Cloud.getUser(name);
                
                App.currentUser = name;
                App.currentWins = wins;
                
                App.updateHUD();
                document.getElementById('user-info').style.display = 'block';
                
                document.getElementById('btn-login').style.display = 'flex';
                document.getElementById('loading').style.display = 'none';
                
                App.switchScreen('menu');
            },

            logout: () => {
                App.currentUser = null;
                location.reload(); // Reload cho s·∫°ch
            },

            updateHUD: () => {
                if (App.currentUser) {
                    document.getElementById('display-name').innerText = App.currentUser;
                    document.getElementById('display-wins').innerText = App.currentWins;
                }
            },

            recordWin: async () => {
                if (!App.currentUser) return;
                // L∆∞u l√™n m√¢y
                const newScore = await Cloud.updateWin(App.currentUser, App.currentWins);
                App.currentWins = newScore;
                App.updateHUD();
            },

            switchScreen: (screenId) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-' + screenId).classList.add('active');
                if (screenId === 'game') window.Game.init();
            },

            showLeaderboard: async () => {
                const list = document.getElementById('lb-list');
                list.innerHTML = 'ƒêang t·∫£i d·ªØ li·ªáu server...';
                App.switchScreen('leaderboard');

                const users = await Cloud.getAllUsers();
                const sorted = Object.entries(users).sort((a, b) => b[1] - a[1]);

                list.innerHTML = '';
                if (sorted.length === 0) {
                    list.innerHTML = '<div style="padding:15px; text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
                } else {
                    sorted.forEach((u, index) => {
                        const isMe = u[0] === App.currentUser;
                        list.innerHTML += `
                            <div class="lb-item" style="${isMe ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                                <span class="lb-rank">#${index + 1}</span>
                                <span class="lb-name">${u[0]} ${isMe ? '(B·∫°n)' : ''}</span>
                                <span class="lb-score">${u[1]} Wins</span>
                            </div>
                        `;
                    });
                }
            }
        };

        // G·∫Øn s·ª± ki·ªán click cho n√∫t Login (v√¨ module kh√¥ng g·ªçi tr·ª±c ti·∫øp t·ª´ HTML onclick ƒë∆∞·ª£c ƒë√¥i khi)
        document.getElementById('btn-login').onclick = App.login;

        // --- GAME ENGINE (GI·ªÆ NGUY√äN LOGIC CORE) ---
        window.Game = {
            cfg: { w: 10, bombs: 12 },
            state: {},
            dom: {},

            init: () => {
                Game.state = { grid: Array(100).fill(0), isOver: false, isFirst: true, flags: 0, safeRevealed: 0, mode: 'dig', time: 0, timerId: null };
                const gridEl = document.getElementById('grid');
                gridEl.innerHTML = '';
                Game.dom.cells = [];
                for (let i = 0; i < 100; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => Game.handleClick(i);
                    cell.oncontextmenu = (e) => { e.preventDefault(); Game.toggleFlag(i); };
                    gridEl.appendChild(cell);
                    Game.dom.cells.push(cell);
                }
                document.getElementById('result-overlay').classList.remove('show');
                Game.updateStats();
                clearInterval(Game.state.timerId);
                document.getElementById('game-timer').innerText = '0';
            },

            setMode: (mode) => {
                Game.state.mode = mode;
                document.getElementById('btn-dig').className = `mode-btn ${mode==='dig'?'active':''}`;
                document.getElementById('btn-flag').className = `mode-btn flag ${mode==='flag'?'active':''}`;
                if(navigator.vibrate) navigator.vibrate(20);
            },

            updateStats: () => { document.getElementById('game-flags').innerText = Game.cfg.bombs - Game.state.flags; },

            handleClick: (idx) => {
                if (Game.state.isOver) return;
                Game.state.mode === 'flag' ? Game.toggleFlag(idx) : Game.dig(idx);
            },

            toggleFlag: (idx) => {
                const cell = Game.dom.cells[idx];
                if (cell.classList.contains('revealed')) return;
                if (cell.classList.contains('flagged')) { cell.classList.remove('flagged'); cell.innerText=''; Game.state.flags--; }
                else if (Game.state.flags < Game.cfg.bombs) { cell.classList.add('flagged'); cell.innerText='üö©'; Game.state.flags++; if(navigator.vibrate) navigator.vibrate(30); }
                Game.updateStats();
            },

            dig: (idx) => {
                const cell = Game.dom.cells[idx];
                if (cell.classList.contains('flagged') || cell.classList.contains('revealed')) return;
                if (Game.state.isFirst) {
                    Game.placeBombs(idx); Game.state.isFirst = false;
                    Game.state.timerId = setInterval(() => { Game.state.time++; document.getElementById('game-timer').innerText = Game.state.time; }, 1000);
                }
                if (Game.state.grid[idx] === 'B') Game.gameOver(false, idx);
                else { Game.reveal(idx); Game.checkWin(); }
            },

            reveal: (idx) => {
                const cell = Game.dom.cells[idx];
                if (cell.classList.contains('revealed')) return;
                cell.classList.add('revealed'); Game.state.safeRevealed++;
                const val = Game.state.grid[idx];
                if (val > 0) { cell.innerText = val; cell.setAttribute('data-v', val); }
                else { Game.getNeighbors(idx).forEach(n => Game.reveal(n)); }
            },

            placeBombs: (safeIdx) => {
                let count = 0;
                while (count < Game.cfg.bombs) {
                    let r = Math.floor(Math.random() * 100);
                    if (r !== safeIdx && Game.state.grid[r] !== 'B') { Game.state.grid[r] = 'B'; count++; }
                }
                for (let i = 0; i < 100; i++) {
                    if (Game.state.grid[i] === 'B') continue;
                    const bombs = Game.getNeighbors(i).filter(n => Game.state.grid[n] === 'B').length;
                    Game.state.grid[i] = bombs;
                }
            },

            getNeighbors: (i) => {
                const w = 10; const l = i%w===0; const r = i%w===w-1;
                const c = [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1];
                return c.filter(x => x >= 0 && x < 100);
            },

            checkWin: () => { if (Game.state.safeRevealed === 100 - Game.cfg.bombs) Game.gameOver(true); },

            gameOver: (isWin, idx) => {
                Game.state.isOver = true; clearInterval(Game.state.timerId);
                Game.state.grid.forEach((v, i) => { if (v === 'B' && !Game.dom.cells[i].classList.contains('flagged')) { Game.dom.cells[i].classList.add('bomb', 'revealed'); Game.dom.cells[i].innerText = 'üí£'; }});
                const msg = document.getElementById('result-msg');
                if (isWin) { msg.innerText = "CHI·∫æN TH·∫ÆNG!"; msg.style.color = "#4ade80"; App.recordWin(); if(navigator.vibrate) navigator.vibrate([100,50,100]); }
                else { msg.innerText = "B·∫†N ƒê√É THUA"; msg.style.color = "#ef4444"; if(idx!==undefined) Game.dom.cells[idx].style.background='#b91c1c'; if(navigator.vibrate) navigator.vibrate(400); }
                setTimeout(() => document.getElementById('result-overlay').classList.add('show'), 800);
            }
        };
    </script>
</body>
</html>
