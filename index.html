<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Minesweeper Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="config.js"></script>
</head>
<body>

    <div id="user-badge" class="user-badge" onclick="App.editProfile()">
        <span>ğŸ‘¤ <span id="u-name">...</span></span> 
        <span style="font-size: 0.8rem; opacity: 0.7;">âœï¸</span>
    </div>

    <div id="screen-login" class="screen active" style="justify-content: center;">
        <div class="card">
            <h1>ÄÄ‚NG NHáº¬P</h1>
            <div class="input-group">
                <span class="input-label">TÃªn ngÆ°á»i chÆ¡i</span>
                <input type="text" id="inp-name" placeholder="VÃ­ dá»¥: ProGamer" maxlength="12">
            </div>
            <button class="btn btn-primary" id="btn-login" onclick="App.login()" style="width:100%">Báº®T Äáº¦U</button>
            <button class="btn btn-danger" id="btn-cancel-login" onclick="App.showMenu()" style="width:100%; display:none;">Há»¦Y Bá»</button>
        </div>
    </div>

    <div id="screen-slogan" class="screen" style="justify-content: center;">
        <div class="card">
            <h1>Há»’ SÆ </h1>
            <h3 id="welcome-user" style="color:var(--primary); margin-bottom: 20px;"></h3>
            <div class="input-group">
                <span class="input-label">MÃ´ táº£ / Slogan (Ngáº¯n gá»n)</span>
                <input type="text" id="inp-desc" placeholder="VÃ­ dá»¥: Báº¥t báº¡i!" maxlength="25">
            </div>
            <button class="btn btn-primary" onclick="App.saveSlogan()" style="width:100%">HOÃ€N Táº¤T</button>
        </div>
    </div>

    <div id="screen-menu" class="screen" style="justify-content: center;">
        <h1>MINESWEEPER</h1>
        
        <button class="btn btn-primary" onclick="window.location.href='choi.html'">
            ğŸ® CHÆ I ÄÆ N
        </button>

        <button class="btn btn-pvp" onclick="window.location.href='choi.html?mode=pvp'">
            <div style="font-size:1.1rem; font-weight:900">âš”ï¸ Äáº¤U PVP</div>
            <div class="pvp-stats">Chá»: <span id="stat-wait">...</span></div>
        </button>

        <button class="btn" style="background: linear-gradient(135deg, #a855f7, #d946ef); border:none; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.5);" onclick="window.location.href='giaitri.html'">
            ğŸª CHáº¾ Äá»˜ GIáº¢I TRÃ
        </button>

        <button class="btn" onclick="window.location.href='xephang.html'">
            ğŸ† Báº¢NG Xáº¾P Háº NG
        </button>

        <button class="btn btn-gold" onclick="window.location.href='thanhtuu.html'">
            ğŸ–ï¸ THÃ€NH Tá»°U
        </button>

        <button class="btn btn-danger" onclick="App.logout()" style="margin-top: 20px;">
            ÄÄ‚NG XUáº¤T
        </button>
        
        <div style="position:absolute; bottom:20px; color:#64748b; font-size:0.8rem">Ver: 24.0 (Full Menu)</div>
    </div>

    <script>
        const LocalState = {
            user: null,
            data: {},
            isEditing: false
        };

        window.App = {
            init: () => {
                // Kiá»ƒm tra Ä‘Äƒng nháº­p tá»« LocalStorage
                const savedUser = localStorage.getItem('ms_user');
                if (savedUser) {
                    LocalState.user = savedUser;
                    App.finishLogin();
                } else {
                    document.getElementById('screen-login').classList.add('active');
                }

                // Láº¯ng nghe sá»‘ ngÆ°á»i online (cho nÃºt PvP Ä‘áº¹p hÆ¡n)
                try {
                    db.ref('waiting').on('value', snap => {
                        const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                        const el = document.getElementById('stat-wait');
                        if(el) el.innerText = count;
                    });
                } catch(e) { console.log("Firebase wait error", e); }
            },

            login: () => {
                const name = document.getElementById('inp-name').value.trim().replace(/[^a-zA-Z0-9]/g, "");
                if (name.length < 2) return alert("TÃªn quÃ¡ ngáº¯n (tá»‘i thiá»ƒu 2 kÃ½ tá»±)!");
                
                document.getElementById('btn-login').innerText = "Äang táº£i...";
                LocalState.user = name;

                // Kiá»ƒm tra trÃªn Firebase
                db.ref('users/' + name).once('value').then(snap => {
                    if (snap.exists()) {
                        LocalState.data = snap.val();
                        if (!LocalState.data.achievements) LocalState.data.achievements = {};
                        
                        if (LocalState.isEditing) {
                            // Äang cháº¿ Ä‘á»™ sá»­a -> Nháº£y vÃ o Slogan
                            document.getElementById('inp-desc').value = LocalState.data.desc || "";
                            document.getElementById('welcome-user').innerText = `Cáº­p nháº­t há»“ sÆ¡: ${name}`;
                            App.showScreen('slogan');
                        } else {
                            // ÄÄƒng nháº­p thÆ°á»ng -> VÃ o Menu
                            localStorage.setItem('ms_user', name);
                            App.finishLogin();
                        }
                    } else {
                        // NgÆ°á»i má»›i -> VÃ o Slogan
                        LocalState.data = { wins: 0, losses: 0, desc: "", achievements: {} };
                        document.getElementById('welcome-user').innerText = `Xin chÃ o ${name}!`;
                        App.showScreen('slogan');
                    }
                }).catch(e => {
                    alert("Lá»—i káº¿t ná»‘i: " + e.message);
                    document.getElementById('btn-login').innerText = "TIáº¾P Tá»¤C";
                });
            },

            saveSlogan: () => {
                const desc = document.getElementById('inp-desc').value.trim();
                LocalState.data.desc = desc;
                
                db.ref('users/' + LocalState.user).update(LocalState.data).then(() => {
                    localStorage.setItem('ms_user', LocalState.user);
                    LocalState.isEditing = false;
                    App.finishLogin();
                });
            },

            finishLogin: () => {
                document.getElementById('u-name').innerText = LocalState.user;
                document.getElementById('user-badge').style.display = 'flex';
                
                // Reset UI Login
                document.getElementById('btn-login').innerText = "TIáº¾P Tá»¤C";
                document.getElementById('btn-cancel-login').style.display = 'none';
                
                App.showMenu();
            },

            editProfile: () => {
                LocalState.isEditing = true;
                document.getElementById('inp-name').value = LocalState.user;
                document.getElementById('btn-login').innerText = "Cáº¬P NHáº¬T";
                document.getElementById('btn-cancel-login').style.display = 'block';
                App.showScreen('login');
            },

            logout: () => {
                localStorage.removeItem('ms_user');
                location.reload();
            },

            showMenu: () => {
                LocalState.isEditing = false;
                App.showScreen('menu');
            },

            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none'; 
                });
                const target = document.getElementById('screen-' + id);
                if(target) {
                    target.classList.add('active');
                    target.style.display = 'flex';
                }
            }
        };

        // Khá»Ÿi cháº¡y
        window.onload = App.init;
    </script>
</body>
</html>
