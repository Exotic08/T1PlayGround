<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Minesweeper PvP Perfect</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- 1. VISUAL CORE --- */
        :root {
            --bg-dark: #0f172a;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #3b82f6; 
            --accent: #10b981; 
            --danger: #ef4444; 
            --gold: #fbbf24;
            --text: #f8fafc; --text-muted: #94a3b8;
            --font: 'Nunito', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: var(--font); }
        body { margin: 0; height: 100vh; background: var(--bg-dark); background-image: var(--bg-gradient); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        /* --- 2. UI ELEMENTS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 80px; z-index: 1;
        }
        .screen.active { display: flex; z-index: 10; animation: fadeIn 0.3s ease; }

        .card {
            background: var(--glass); border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px); border-radius: 24px;
            padding: 30px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        h1 {
            font-size: 2.2rem; margin-bottom: 1.5rem; text-align: center;
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 2px; font-weight: 900;
        }

        .btn {
            position: relative; overflow: hidden;
            background: rgba(255,255,255,0.08); color: white; border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 25px; margin: 8px; border-radius: 16px;
            font-size: 1rem; font-weight: 800; cursor: pointer;
            width: 85%; max-width: 320px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5); border: none; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
        .btn-gold { background: rgba(251, 191, 36, 0.2); border-color: var(--gold); color: var(--gold); }
        
        .btn-pvp { 
            background: linear-gradient(135deg, #ec4899, #8b5cf6); border: none; 
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.5); 
            flex-direction: column; gap: 2px; padding: 12px 20px;
        }
        .pvp-stats { font-size: 0.8rem; font-weight: normal; opacity: 0.9; }
        
        .btn-watch { background: #8b5cf6; border: none; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5); width: 80%; margin-top: 10px; }

        input { width: 100%; padding: 16px; border-radius: 14px; background: rgba(0, 0, 0, 0.3); border: 2px solid var(--glass-border); color: white; font-size: 1.1rem; text-align: center; font-weight: 700; outline: none; margin-bottom: 20px; }
        input:focus { border-color: var(--primary); }

        /* --- 3. GAME BOARD --- */
        .game-header { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 12px; font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; border: 1px solid var(--glass-border); }
        
        .board-container { width: 95vw; max-width: 400px; aspect-ratio: 1/1; background: rgba(30, 41, 59, 0.6); padding: 10px; border-radius: 20px; position: relative; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); }
        .grid { display: grid; width: 100%; height: 100%; gap: 5px; grid-template-columns: repeat(10, 1fr); }
        
        /* CELL - Fixed Rectangle Bug */
        .cell { width: 100%; aspect-ratio: 1/1; background: #334155; border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: clamp(12px, 4.5vw, 22px); color: white; box-shadow: 0 4px 0 #1e293b; transition: transform 0.1s; }
        .cell:active { transform: translateY(4px); box-shadow: none; }
        .cell.revealed { background: #1e293b; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transform: translateY(4px); cursor: default; border: 1px solid rgba(255,255,255,0.05); }
        .cell.flagged { color: #ef4444; text-shadow: 0 0 10px rgba(239,68,68,0.8); }
        .cell.bomb { background: var(--danger) !important; box-shadow: none; animation: shake 0.5s; transform: translateY(4px); z-index: 2; border: 2px solid white;}
        .c1{color:#60a5fa} .c2{color:#4ade80} .c3{color:#f87171} .c4{color:#c084fc} .c5{color:#fbbf24}

        /* OVERLAY */
        #game-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; backdrop-filter: blur(15px); }
        #game-overlay.show { display: flex !important; animation: fadeIn 0.3s; }
        .result-title { font-size: 3rem; font-weight: 900; margin-bottom: 5px; text-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .result-desc { color: #cbd5e1; margin-bottom: 30px; text-align: center; padding: 0 20px; font-size: 1.2rem;}
        
        /* CONTROLS */
        .controls { display: flex; gap: 15px; width: 95%; max-width: 400px; margin-top: 25px; }
        .mode-btn { flex: 1; padding: 20px; border-radius: 16px; background: rgba(255,255,255,0.05); color: var(--text-muted); font-weight: 800; border: none; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.3s; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 20px rgba(59, 130, 246, 0.5); transform: translateY(-3px); }
        .mode-btn.active.flag { background: var(--danger); box-shadow: 0 5px 20px rgba(239,68,68,0.5); }

        /* LEADERBOARD & ACH */
        .lb-container { width: 95%; max-width: 420px; height: 65vh; display: flex; flex-direction: column; position: relative; }
        .lb-header-row { display: grid; grid-template-columns: 45px 1fr 90px; padding: 10px 15px; color: #94a3b8; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        .lb-tabs { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 16px; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; color: var(--text-muted); border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(59,130,246,0.3); }
        .lb-list, .ach-list { flex: 1; overflow-y: auto; padding: 0 5px; margin: 0; list-style: none; padding-bottom: 70px; scrollbar-width: thin; }
        
        /* HIGHLIGHT TOP 3 */
        .lb-item { display: grid; grid-template-columns: 45px 1fr 90px; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); margin-bottom: 10px; padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .lb-rank { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 1rem; }
        .lb-top1 .lb-rank { background: var(--gold); color: black; box-shadow: 0 0 15px var(--gold); }
        .lb-top2 .lb-rank { background: #e2e8f0; color: black; box-shadow: 0 0 10px white; }
        .lb-top3 .lb-rank { background: #d97706; color: white; box-shadow: 0 0 10px #d97706; }
        
        .ach-item { display: grid; grid-template-columns: 50px 1fr 30px; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 12px; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .ach-item.unlocked { opacity: 1; filter: grayscale(0); background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-color: var(--accent); }
        .ach-title { font-weight: 800; color: var(--gold); margin-bottom: 4px; }
        
        /* UTILS */
        .pc-switch { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 20px; cursor: pointer; border: 1px solid var(--glass-border); }
        .pc-dot { width: 10px; height: 10px; border-radius: 50%; background: #64748b; transition: 0.3s; }
        .pc-switch.on .pc-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
        #user-badge { position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; display: none; align-items: center; gap: 8px; cursor: pointer; }
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        
        .spectator-mode { border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        #spec-msg { position: absolute; top: 75px; background: var(--gold); color: black; padding: 6px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 90; display: none; font-weight: 800; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: popIn 0.3s; }
    </style>
</head>
<body>

    <div id="error-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:red; z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;"><h2>‚ö†Ô∏è L·ªñI</h2><p id="error-msg"></p><button class="btn" onclick="location.reload()">T·∫£i L·∫°i</button></div>
    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:12px 24px; border-radius:50px; z-index:200; display:none; font-weight:bold; box-shadow: 0 10px 20px rgba(0,0,0,0.3); animation: popIn 0.3s;">üèÜ M·ªü kh√≥a th√†nh t·ª±u!</div>
    
    <div id="user-badge" onclick="App.editProfile()"><span>üë§ <span id="u-name">...</span></span><span>‚úèÔ∏è</span></div>
    <div id="spec-msg">üëÅÔ∏è ƒêANG XEM ƒê·ªêI TH·ª¶</div>

    <div id="screen-login" class="screen active" style="justify-content: center;">
        <div class="card">
            <h1>ƒêƒÇNG NH·∫¨P</h1>
            <div class="input-group" style="text-align: left;">
                <span style="color:#94a3b8; font-size:0.9rem; margin-left:5px; font-weight:bold;">T√™n ng∆∞·ªùi ch∆°i</span>
                <input type="text" id="inp-name" placeholder="V√≠ d·ª•: ProGamer" maxlength="12">
            </div>
            <button class="btn btn-primary" id="btn-login" onclick="App.login()" style="width:100%">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn btn-danger" id="btn-cancel-login" onclick="App.toMenu()" style="width:100%; display:none;">H·ª¶Y B·ªé</button>
        </div>
    </div>

    <div id="screen-slogan" class="screen" style="justify-content: center;">
        <div class="card">
            <h1>H·ªí S∆†</h1>
            <h3 id="welcome-user" style="color:var(--primary); margin-bottom: 20px;"></h3>
            <input type="text" id="inp-desc" placeholder="Slogan / M√¥ t·∫£ ng·∫Øn" maxlength="25">
            <button class="btn btn-primary" onclick="App.saveSlogan()" style="width:100%">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <div id="screen-menu" class="screen" style="justify-content: center;">
        <h1>MINESWEEPER</h1>
        <button class="btn btn-primary" onclick="App.playSingle()">üéÆ CH∆†I ƒê∆†N</button>
        <button class="btn btn-pvp" onclick="App.findMatch()">
            <div style="font-size:1.1rem; font-weight:900">‚öîÔ∏è ƒê·∫§U PVP</div>
            <div class="pvp-stats">ƒêang ch·ªù: <span id="stat-wait" style="font-weight:bold; color:white">0</span></div>
        </button>
        <button class="btn" onclick="App.leaderboard('wins')">üèÜ B·∫¢NG X·∫æP H·∫†NG</button>
        <button class="btn btn-gold" onclick="App.achievements()">üéñÔ∏è TH√ÄNH T·ª∞U</button>
        <div style="position:absolute; bottom:20px; color:#64748b; font-size:0.8rem">Ver: Final 17.0</div>
    </div>

    <div id="screen-match" class="screen" style="justify-content: center;">
        <h2 style="color: var(--accent)">T√åM ƒê·ªêI TH·ª¶</h2>
        <div style="border:3px solid rgba(255,255,255,0.1); border-top:3px solid var(--primary); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:30px;"></div>
        <p id="match-log" style="color: var(--text-muted)">ƒêang k·∫øt n·ªëi...</p>
        <button class="btn btn-danger" onclick="App.cancelMatch()">H·ª¶Y B·ªé</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="btn-icon" onclick="App.quitGame()">‚¨Ö</button>
            <div id="pc-switch" class="pc-switch" onclick="Game.togglePC()"><div class="pc-dot"></div><span class="pc-text">PC MODE</span></div>
        </div>

        <div style="display: flex; gap: 20px; margin-bottom: 15px; width: 95%; max-width: 400px; justify-content: space-between;">
            <div class="stat-box" style="color:#ef4444">üö© <span id="g-flags">0</span></div>
            <div id="pvp-info" style="color: var(--accent); font-weight: bold; display: none;">VS <span id="opp-name">...</span></div>
            <div class="stat-box" style="color:#fff">‚è±Ô∏è <span id="g-time">0</span></div>
        </div>

        <div id="board-container" class="board-container">
            <div id="grid" class="grid"></div>
            <div id="game-overlay" class="overlay">
                <h1 id="res-title" class="result-title"></h1>
                <p id="res-desc" class="result-desc"></p>
                <button id="btn-watch" class="btn btn-watch" onclick="Game.spectate()">üëÅÔ∏è XEM ƒê·ªêI TH·ª¶</button>
                <button id="btn-replay" class="btn btn-primary" onclick="App.playSingle()" style="width:80%">CH∆†I L·∫†I</button>
                <button class="btn" onclick="App.toMenu()" style="width:80%">V·ªÄ MENU</button>
            </div>
        </div>

        <div id="mob-ctrl" class="controls">
            <button id="btn-dig" class="mode-btn active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
            <button id="btn-flag" class="mode-btn flag" onclick="Game.setMode('flag')">üö© C·∫ÆM C·ªú</button>
        </div>
        <div id="pc-hint" style="display:none; color: #64748b; margin-top: 15px; font-size: 0.9rem; text-align: center;">Chu·ªôt tr√°i: ƒê√†o | Chu·ªôt ph·∫£i: C·∫Øm c·ªù</div>
    </div>

    <div id="screen-lb" class="screen">
        <div class="game-header" style="justify-content: flex-start; gap: 15px;">
            <button class="btn-icon" onclick="App.toMenu()">‚¨Ö</button> <h2 style="margin:0">X·∫æP H·∫†NG</h2>
        </div>
        <div class="lb-container">
            <div class="lb-tabs">
                <button id="tab-wins" class="tab-btn active" onclick="App.leaderboard('wins')">TH·∫ÆNG</button>
                <button id="tab-time" class="tab-btn" onclick="App.leaderboard('time')">T·ªêC ƒê·ªò</button>
                <button id="tab-rate" class="tab-btn" onclick="App.leaderboard('rate')">T·ªà L·ªÜ</button>
            </div>
            <div class="lb-header-row"><div>#</div><div>Ng∆∞·ªùi ch∆°i</div><div style="text-align:right">ƒêi·ªÉm</div></div>
            <ul id="lb-list" class="lb-list"></ul>
        </div>
    </div>

    <div id="screen-ach" class="screen">
        <div class="game-header" style="justify-content: flex-start; gap: 15px;">
            <button class="btn-icon" onclick="App.toMenu()">‚¨Ö</button> <h2 style="margin:0">TH√ÄNH T·ª∞U</h2>
        </div>
        <div id="ach-list" class="ach-list"></div>
    </div>

    <script>
        window.onerror = function(msg) { document.getElementById('error-screen').style.display = 'flex'; document.getElementById('error-msg').innerText = msg; };
        
        const firebaseConfig = {
            apiKey: "AIzaSyDXn3IK3Td2WyegZkU0m1hESQQSRLM1Zb8",
            authDomain: "minesweeper-a7423.firebaseapp.com",
            databaseURL: "https://minesweeper-a7423-default-rtdb.firebaseio.com",
            projectId: "minesweeper-a7423",
            storageBucket: "minesweeper-a7423.firebasestorage.app",
            messagingSenderId: "305681879682",
            appId: "1:305681879682:web:31f1a90362b20b06cbda9b",
            measurementId: "G-XBJQF7Q242"
        };

        try { firebase.initializeApp(firebaseConfig); var db = firebase.database(); } catch(e) { console.error(e); }

        class SeededRandom {
            constructor(seed) { this.seed = seed; }
            next() { var t = this.seed += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }
        }

        const LIST_ACH = [
            { id: 'win1', title: 'T√¢n Binh', desc: 'Th·∫Øng tr·∫≠n ƒë·∫ßu ti√™n', stars: 1, icon: 'üê£' },
            { id: 'win10', title: 'Chuy√™n Gia', desc: 'Th·∫Øng 10 tr·∫≠n', stars: 2, icon: 'üí£' },
            { id: 'speed60', title: 'Th·∫ßn T·ªëc', desc: 'Th·∫Øng d∆∞·ªõi 60s', stars: 3, icon: '‚ö°' },
            { id: 'num5', title: 'T·ª≠ Th·∫ßn', desc: 'M·ªü √¥ s·ªë 5', stars: 2, icon: 'üíÄ' }
        ];

        const State = { user: null, data: {}, matchId: null, isPvP: false, waitingRef: null, opponent: null, matchStartTime: 0, currentSeed: 0 };

        window.App = {
            initServerStats: () => {
                db.ref('waiting').on('value', snap => {
                    var count = snap.exists() ? Object.keys(snap.val()).length : 0;
                    document.getElementById('stat-wait').innerText = count;
                });
            },
            login: () => {
                var name = document.getElementById('inp-name').value.trim().replace(/[^a-zA-Z0-9]/g, "");
                if(name.length < 2) return alert("T√™n qu√° ng·∫Øn!");
                document.getElementById('btn-login').innerText = "ƒêang t·∫£i...";
                State.user = name;
                db.ref('users/' + name).once('value').then(snap => {
                    if(snap.exists()) {
                        State.data = snap.val();
                        if(!State.data.achievements) State.data.achievements = {};
                        App.finishLogin();
                    } else {
                        State.data = { wins: 0, losses: 0, desc: "", achievements: {} };
                        document.getElementById('welcome-user').innerText = 'Xin ch√†o ' + name + '!';
                        App.showScreen('slogan');
                    }
                }).catch(e => alert("L·ªói m·∫°ng: " + e.message));
            },
            saveSlogan: () => {
                State.data.desc = document.getElementById('inp-desc').value.trim();
                db.ref('users/' + State.user).update(State.data).then(() => App.finishLogin());
            },
            finishLogin: () => {
                document.getElementById('u-name').innerText = State.user;
                document.getElementById('user-badge').style.display = 'flex';
                document.getElementById('btn-login').innerText = "B·∫ÆT ƒê·∫¶U";
                document.getElementById('btn-cancel-login').style.display = 'none';
                App.toMenu();
                App.initServerStats();
            },
            editProfile: () => {
                if(!State.user) return;
                document.getElementById('inp-name').value = State.user;
                document.getElementById('btn-login').innerText = "C·∫¨P NH·∫¨T";
                document.getElementById('btn-cancel-login').style.display = 'block';
                App.showScreen('login');
            },
            toMenu: () => {
                App.showScreen('menu');
                if(State.waitingRef) State.waitingRef.remove();
                State.matchId = null; State.isPvP = false;
                document.getElementById('spec-msg').style.display = 'none';
            },
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
            },
            playSingle: () => {
                State.isPvP = false;
                document.getElementById('pvp-info').style.display = 'none';
                document.getElementById('btn-watch').style.display = 'none';
                document.getElementById('btn-replay').style.display = 'block';
                document.getElementById('board-container').classList.remove('spectator-mode');
                App.showScreen('game');
                Game.init(Math.floor(Math.random()*100000));
            },
            findMatch: () => {
                App.showScreen('match');
                document.getElementById('match-log').innerText = "ƒêang t√¨m ph√≤ng...";
                db.ref('waiting').once('value').then(snap => {
                    if(snap.exists()) {
                        var users = snap.val();
                        var oppKey = Object.keys(users)[0];
                        if(oppKey === State.user) { document.getElementById('match-log').innerText = "ƒêang ƒë·ª£i..."; return; }
                        var oppName = users[oppKey];
                        db.ref('waiting/' + oppKey).remove();
                        document.getElementById('match-log').innerText = 'T√¨m th·∫•y: ' + oppName + '!';
                        var mid = 'm_' + Date.now();
                        var seed = Math.floor(Math.random()*100000);
                        var start = Date.now() + 1000;
                        db.ref('matches/' + mid).set({ p1: oppName, p2: State.user, seed: seed, startTime: start, winner: "" });
                        db.ref('users/' + oppName + '/match').set(mid);
                        App.enterPvP(mid, seed, oppName, start);
                    } else {
                        document.getElementById('match-log').innerText = "ƒêang ƒë·ª£i ng∆∞·ªùi ch∆°i kh√°c...";
                        State.waitingRef = db.ref('waiting/' + State.user);
                        State.waitingRef.set(State.user);
                        State.waitingRef.onDisconnect().remove();
                        var myMatch = db.ref('users/' + State.user + '/match');
                        myMatch.onDisconnect().remove();
                        myMatch.on('value', snap => {
                            var mid = snap.val();
                            if(mid) {
                                myMatch.remove(); State.waitingRef.remove();
                                db.ref('matches/' + mid).once('value').then(ms => {
                                    var d = ms.val();
                                    App.enterPvP(mid, d.seed, d.p2, d.startTime);
                                });
                            }
                        });
                    }
                });
            },
            cancelMatch: () => { if(State.waitingRef) State.waitingRef.remove(); App.toMenu(); },
            enterPvP: (mid, seed, opp, start) => {
                State.isPvP = true; State.matchId = mid; State.opponent = opp; State.matchStartTime = start;
                document.getElementById('pvp-info').style.display = 'block';
                document.getElementById('opp-name').innerText = opp;
                document.getElementById('btn-replay').style.display = 'none';
                document.getElementById('btn-watch').style.display = 'none';
                document.getElementById('board-container').classList.remove('spectator-mode');
                App.showScreen('game');
                Game.init(seed);
                db.ref('matches/' + mid + '/winner').on('value', snap => {
                    var w = snap.val();
                    if(w) {
                        if(w === "DRAW") Game.showRes("DRAW");
                        else if(w === State.user) Game.end(true);
                        else if(!Game.isOver && !Game.isSpectating) Game.pvpLose();
                    }
                });
                db.ref('matches/'+mid+'/dead').on('value', snap => {
                    var d = snap.val();
                    if(d && d[State.user] && d[State.opponent]) db.ref('matches/'+mid).update({winner: "DRAW"});
                });
            },
            quitGame: () => {
                if(State.isPvP && !Game.isOver) db.ref('matches/' + State.matchId).update({winner: State.opponent});
                App.toMenu();
            },
            leaderboard: (type) => {
                App.showScreen('lb');
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-'+type).classList.add('active');
                var list = document.getElementById('lb-list');
                list.innerHTML = '<li style="padding:20px;text-align:center">ƒêang t·∫£i...</li>';
                db.ref('users').once('value').then(snap => {
                    if(snap.exists()) {
                        var arr = [];
                        snap.forEach(c => {
                            var u = c.val();
                            if(typeof u === 'number') u = {wins:u, losses:0, bestTime:999999};
                            if((u.wins||0)+(u.losses||0) > 0) arr.push({name:c.key, ...u});
                        });
                        if(type==='wins') arr.sort((a,b)=> (b.wins||0)-(a.wins||0));
                        else if(type==='time') arr.sort((a,b)=> a.bestTime - b.bestTime);
                        else arr.sort((a,b) => { var rA = a.wins/(a.wins+a.losses)||0; var rB = b.wins/(b.wins+b.losses)||0; return rB - rA; });

                        list.innerHTML = '';
                        arr.slice(0, 10).forEach((u, i) => {
                            var rate = u.wins+u.losses > 0 ? ((u.wins/(u.wins+u.losses))*100).toFixed(0) : 0;
                            var val = type==='wins' ? u.wins : (type==='time' ? (u.bestTime<999999?u.bestTime+'s':'--') : rate+'%');
                            var rankClass = i<3 ? 'lb-top'+(i+1) : '';
                            list.innerHTML += `
                                <li class="lb-item ${rankClass}" style="${u.name===State.user?'background:rgba(59,130,246,0.15); border-color:var(--primary)':''}">
                                    <div class="lb-rank">${i+1}</div>
                                    <div class="lb-info"><div class="lb-name">${u.name}</div><div class="lb-desc">${u.desc||""}</div></div>
                                    <div class="lb-val">${val}</div>
                                </li>`;
                        });
                    }
                });
            },
            achievements: () => {
                App.showScreen('ach');
                var list = document.getElementById('ach-list');
                list.innerHTML = '';
                LIST_ACH.forEach(a => {
                    var ul = State.data.achievements[a.id];
                    var starStr = '‚≠ê'.repeat(a.stars);
                    list.innerHTML += `
                        <div class="ach-item ${ul?'unlocked':''}">
                            <div class="ach-icon">${a.icon}</div>
                            <div class="ach-content"><div class="ach-title">${a.title}</div><div style="color:var(--gold);font-size:0.8rem;margin-bottom:2px">${starStr}</div><div class="ach-desc">${a.desc}</div></div>
                            ${ul ? '<div class="ach-status">‚úÖ</div>' : ''}
                        </div>`;
                });
            },
            unlockAch: (id) => {
                if(State.user && !State.data.achievements[id]){
                    State.data.achievements[id] = true;
                    db.ref('users/'+State.user+'/achievements/'+id).set(true);
                    var t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
                }
            },
            saveWin: (time) => {
                if(!State.user) return;
                State.data.wins++;
                if(time < State.data.bestTime) State.data.bestTime = time;
                db.ref('users/'+State.user).update(State.data);
                App.unlockAch('win1'); if(State.data.wins>=10) App.unlockAch('win10'); if(time<60) App.unlockAch('speed60');
                return time === State.data.bestTime;
            },
            saveLoss: () => {
                if(!State.user) return;
                State.data.losses = (State.data.losses||0) + 1;
                db.ref('users/'+State.user).update(State.data);
            }
        };

        window.Game = {
            w: 10, bombs: 15, grid: [], dom: [], rng: null,
            isOver: false, isPC: false, isSpectating: false, timer: null, time: 0, flags: 0, revealed: 0, firstClick: true, mode: 'dig',

            init: (seed) => {
                if(Game.timer) clearInterval(Game.timer);
                State.currentSeed = seed;
                Game.isOver = false; Game.isSpectating = false; Game.time = 0; Game.flags = 0; Game.revealed = 0; Game.firstClick = true;
                Game.rng = new SeededRandom(seed);
                var g = document.getElementById('grid'); g.innerHTML = '';
                document.getElementById('game-overlay').classList.remove('show');
                document.getElementById('g-time').innerText = '0';
                document.getElementById('g-flags').innerText = Game.bombs;
                Game.grid = Array(100).fill(0); Game.dom = [];
                for(var i=0; i<100; i++){
                    (function(i){
                        var c = document.createElement('div'); c.className = 'cell';
                        c.onclick = function() { Game.click(i); };
                        c.oncontextmenu = function(e) { e.preventDefault(); Game.toggleFlag(i); };
                        g.appendChild(c); Game.dom.push(c);
                    })(i);
                }
            },
            click: (i) => {
                if(Game.isOver || Game.isSpectating) return;
                var c = Game.dom[i];
                if(c.classList.contains('revealed') && Game.grid[i]>0) return Game.chord(i);
                Game.isPC ? Game.dig(i) : (Game.mode==='flag'?Game.toggleFlag(i):Game.dig(i));
            },
            dig: (i, fromSpec) => {
                if(!fromSpec && Game.isSpectating) return;
                var c = Game.dom[i];
                if(c.classList.contains('revealed')||c.classList.contains('flagged')) return;
                if(Game.firstClick) {
                    Game.firstClick = false; Game.plant(i);
                    if(!fromSpec) Game.timer = setInterval(function(){
                        if(State.isPvP && State.matchStartTime) Game.time = Math.floor((Date.now() - State.matchStartTime)/1000);
                        else Game.time++;
                        document.getElementById('g-time').innerText=Game.time;
                    }, 1000);
                }
                if(State.isPvP && !fromSpec) db.ref('matches/'+State.matchId+'/moves/'+State.user+'/'+i).set(1);
                if(Game.grid[i]==='B') { if(!fromSpec) Game.end(false, i); }
                else { Game.reveal(i); if(Game.revealed === 100-Game.bombs && !fromSpec) Game.end(true); }
            },
            reveal: (i) => {
                var c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                c.classList.add('revealed'); Game.revealed++;
                if(Game.grid[i]>0) { c.innerText = Game.grid[i]; c.classList.add('c'+Game.grid[i]); if(Game.grid[i]===5) App.unlockAch('num5'); }
                else Game.getN(i).forEach(function(n){ Game.reveal(n) });
            },
            toggleFlag: (i) => {
                var c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                if(c.classList.contains('flagged')) { c.classList.remove('flagged'); c.innerText=''; Game.flags--; }
                else if(Game.flags<15) { c.classList.add('flagged'); c.innerText='üö©'; Game.flags++; }
                document.getElementById('g-flags').innerText = Game.bombs - Game.flags;
                if(State.isPvP && !Game.isSpectating) {
                    var val = c.classList.contains('flagged') ? 3 : null;
                    db.ref('matches/'+State.matchId+'/moves/'+State.user+'/'+i).set(val);
                }
            },
            chord: (i) => {
                var n = Game.getN(i);
                if(n.filter(function(x){ return Game.dom[x].classList.contains('flagged') }).length === Game.grid[i]) 
                    n.forEach(function(x){ if(!Game.dom[x].classList.contains('flagged')) Game.dig(x); });
                else { Game.dom[i].classList.add('chord-error'); setTimeout(function(){Game.dom[i].classList.remove('chord-error')},300); }
            },
            plant: (s) => {
                var c=0; while(c<15) { var r=Math.floor(Game.rng.next()*100); if(r!==s && Game.grid[r]!=='B') { Game.grid[r]='B'; c++; } }
                for(var i=0; i<100; i++) if(Game.grid[i]!=='B') Game.grid[i] = Game.getN(i).filter(function(n){return Game.grid[n]==='B'}).length;
            },
            getN: (i) => { var w=10, l=i%w===0, r=i%w===w-1; return [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1].filter(function(x){return x>=0&&x<100}); },
            end: (w, i) => {
                if(Game.isSpectating) return;
                Game.isOver = true; clearInterval(Game.timer);
                if(State.isPvP) {
                    if(w) { db.ref('matches/'+State.matchId).update({winner:State.user}); Game.showRes(true); }
                    else { db.ref('matches/'+State.matchId+'/dead/'+State.user).set(true); App.saveLoss(); Game.showRes(false, i); }
                } else Game.showRes(w, i);
            },
            pvpLose: () => { Game.isOver = true; clearInterval(Game.timer); Game.showRes(false); },
            showRes: (w, i) => {
                if(!w && i!==undefined) {
                    Game.grid.forEach(function(v,x){ if(v==='B' && !Game.dom[x].classList.contains('flagged')) {Game.dom[x].classList.add('revealed','bomb'); Game.dom[x].innerText='üí£';}});
                    if(i!==null) Game.dom[i].style.background="#ef4444";
                }
                var t=document.getElementById('res-title'); var d=document.getElementById('res-desc');
                var bw=document.getElementById('btn-watch'); var br=document.getElementById('btn-replay');
                if(w === "DRAW") {
                    t.innerText = "H√íA NHAU!"; t.style.color = "#94a3b8"; d.innerText = "C·∫£ hai ƒë·ªÅu n·ªï bom!";
                    br.style.display='none'; bw.style.display='none';
                }
                else if(w) {
                    t.innerText="CHI·∫æN TH·∫ÆNG!"; t.style.color="#4ade80";
                    d.innerText = State.isPvP ? "Th·∫Øng ƒë·ªëi th·ªß: " + State.opponent : "Xu·∫•t s·∫Øc!";
                    if(!State.isPvP) { var r = App.saveWin(Game.time); d.innerHTML+= (r?"<br>üöÄ K·ª∂ L·ª§C M·ªöI!":""); }
                    br.style.display='block'; bw.style.display='none';
                } else {
                    t.innerText="THUA R·ªíI!"; t.style.color="#ef4444";
                    if(State.isPvP) {
                        d.innerText = Game.isSpectating ? "ƒê·ªëi th·ªß ƒë√£ th·∫Øng!" : "B·∫°n ƒë√£ n·ªï bom!";
                        br.style.display='none'; bw.style.display=Game.isSpectating?'none':'block';
                    } else {
                        d.innerText = "Th·ª≠ l·∫°i nh√©!"; App.saveLoss();
                        br.style.display='block'; bw.style.display='none';
                    }
                }
                setTimeout(function(){document.getElementById('game-overlay').classList.add('show')}, 500);
            },
            spectate: () => {
                Game.isSpectating = true;
                Game.init(State.currentSeed); // RE-INIT TO CLEAR BOARD
                document.getElementById('game-overlay').classList.remove('show');
                document.getElementById('spec-msg').style.display = 'block';
                document.getElementById('board-container').classList.add('spectator-mode');
                
                if(State.matchStartTime) {
                    Game.timer = setInterval(function(){
                       Game.time = Math.floor((Date.now() - State.matchStartTime)/1000);
                       document.getElementById('g-time').innerText = Game.time;
                    }, 1000);
                }

                db.ref('matches/' + State.matchId + '/moves/' + State.opponent).on('value', function(snap) {
                    if(snap.exists()) {
                        var m = snap.val();
                        Object.keys(m).forEach(function(k) { 
                            var val = m[k];
                            if(val === 3) { if(!Game.dom[k].classList.contains('revealed')) { Game.dom[k].classList.add('flagged'); Game.dom[k].innerText='üö©'; } }
                            else if(val === 2) { Game.dom[k].classList.add('revealed', 'bomb'); Game.dom[k].innerText='üí£'; Game.dom[k].style.background="#ef4444"; }
                            else if(val === 1 && !Game.dom[k].classList.contains('revealed')) { Game.dig(parseInt(k), true); }
                            else if(val === null && Game.dom[k].classList.contains('flagged')) { Game.dom[k].classList.remove('flagged'); Game.dom[k].innerText=''; }
                        });
                    }
                });
            },
            togglePC: () => { Game.isPC = !Game.isPC; var s=document.getElementById('pc-switch'); var h=document.getElementById('pc-hint'); var m=document.getElementById('mob-ctrl'); if(Game.isPC) { s.classList.add('on'); h.style.display='block'; m.style.display='none'; } else { s.classList.remove('on'); h.style.display='none'; m.style.display='flex'; } },
            setMode: (m) => { Game.mode=m; document.getElementById('btn-dig').className='mode-btn '+(m==='dig'?'active':''); document.getElementById('btn-flag').className='mode-btn flag '+(m==='flag'?'active':''); }
        };
    </script>
</body>
</html>
