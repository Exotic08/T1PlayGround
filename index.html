<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minesweeper Pro Online</title>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #111827;
            --panel: #1f2937;
            --primary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --text: #f3f4f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- SCREEN MANAGER --- */
        .screen {
            position: absolute; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: var(--bg);
            transition: opacity 0.3s ease;
            opacity: 0; pointer-events: none; z-index: 0;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 10; }

        h1 { font-size: 1.8rem; margin-bottom: 2rem; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        /* --- UI COMPONENTS --- */
        .btn {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--primary);
            padding: 16px 24px;
            margin: 8px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 80%; max-width: 300px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: var(--shadow);
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; position: absolute; top: 15px; left: 15px; z-index: 50; }

        input {
            padding: 15px;
            border-radius: 12px;
            background: var(--panel);
            border: 1px solid #374151;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            width: 80%; max-width: 300px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }

        /* --- GAME BOARD --- */
        .game-area {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        .hud {
            display: flex; justify-content: space-between; width: 95vw; max-width: 400px;
            margin-bottom: 10px; padding: 10px 20px;
            background: var(--panel); border-radius: 12px;
            font-weight: bold; font-size: 1.2rem;
        }

        .board-container {
            width: 95vw; max-width: 400px;
            aspect-ratio: 1/1;
            background: var(--panel);
            padding: 5px; border-radius: 8px;
            position: relative;
        }

        .grid {
            display: grid; width: 100%; height: 100%; gap: 2px;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
        }

        .cell {
            background: #374151; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 900; font-size: 18px; cursor: pointer;
            transition: background 0.1s;
        }
        .cell.revealed { background: #1f2937; border: 1px solid #374151; cursor: default; }
        .cell.flagged { background: #374151; }
        .cell.bomb { background: var(--danger) !important; animation: explode 0.3s; }
        @keyframes explode { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* Colors for numbers */
        .c1 { color: #60a5fa; } .c2 { color: #4ade80; } .c3 { color: #f87171; } .c4 { color: #c084fc; } 
        .c5 { color: #fbbf24; } .c6 { color: #2dd4bf; } .c7 { color: #e879f9; } .c8 { color: #9ca3af; }

        /* --- CONTROLS --- */
        .controls {
            display: flex; width: 95vw; max-width: 400px; margin-top: 15px; gap: 10px;
        }
        .toggle-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none;
            background: #374151; color: #9ca3af; font-weight: bold; font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .toggle-btn.active { flex: 1.5; color: #111827; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        .toggle-btn.dig.active { background: var(--accent); }
        .toggle-btn.flag.active { background: var(--danger); }

        /* --- LEADERBOARD & OVERLAY --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; backdrop-filter: blur(5px);
        }
        .overlay.show { display: flex; animation: fadeIn 0.3s; }
        
        .lb-list {
            list-style: none; padding: 0; width: 90%; max-width: 350px;
            max-height: 60vh; overflow-y: auto;
            background: var(--panel); border-radius: 12px;
        }
        .lb-item {
            display: flex; justify-content: space-between; padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .lb-rank { font-weight: bold; color: #6b7280; width: 30px; }
        .lb-name { flex: 1; font-weight: 600; text-align: left; padding-left: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .lb-score { color: var(--accent); font-weight: 800; }
        .lb-me { background: rgba(59, 130, 246, 0.15); border-left: 3px solid var(--primary); }

        /* User Status Bar */
        .status-bar {
            position: absolute; top: 0; right: 0; z-index: 50;
            background: rgba(31, 41, 55, 0.9); padding: 8px 12px;
            border-bottom-left-radius: 10px; font-size: 0.9rem;
            display: none; border-left: 1px solid #374151; border-bottom: 1px solid #374151;
        }
    </style>
</head>
<body>

    <div id="user-status" class="status-bar">
        üë§ <span id="ui-name">...</span> | üèÜ <span id="ui-score">0</span>
    </div>

    <div id="screen-login" class="screen active">
        <h1>MINESWEEPER PRO</h1>
        <input type="text" id="inp-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n (T·ªëi ƒëa 10 k√Ω t·ª±)" maxlength="10">
        <button class="btn btn-primary" id="btn-login">B·∫ÆT ƒê·∫¶U CHI·∫æN</button>
        <p id="msg-login" style="color: var(--accent); min-height: 20px; font-size: 0.9rem;"></p>
    </div>

    <div id="screen-menu" class="screen">
        <h1>MENU CH√çNH</h1>
        <button class="btn btn-primary" onclick="App.play()">üéÆ CH∆†I NGAY</button>
        <button class="btn" onclick="App.leaderboard()">üèÜ B·∫¢NG X·∫æP H·∫†NG</button>
        <button class="btn btn-danger" onclick="App.logout()">Tho√°t</button>
    </div>

    <div id="screen-game" class="screen">
        <button class="btn btn-icon" onclick="App.nav('menu')">‚¨Ö</button>
        <div class="game-area">
            <div class="hud">
                <span>üö© <span id="g-flags">0</span></span>
                <span>‚è±Ô∏è <span id="g-time">0</span></span>
            </div>
            
            <div class="board-container">
                <div id="grid" class="grid"></div>
                
                <div id="overlay-result" class="overlay">
                    <h1 id="res-title">TH·∫ÆNG!</h1>
                    <button class="btn btn-primary" onclick="Game.init()">Ch∆°i L·∫°i</button>
                    <button class="btn" onclick="App.nav('menu')">V·ªÅ Menu</button>
                </div>
            </div>

            <div class="controls">
                <button id="mode-dig" class="toggle-btn dig active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
                <button id="mode-flag" class="toggle-btn flag" onclick="Game.setMode('flag')">üö© C·∫ÆM C·ªú</button>
            </div>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <button class="btn btn-icon" onclick="App.nav('menu')">‚¨Ö</button>
        <h2 style="color:var(--accent); margin-top: 60px;">B·∫¢NG X·∫æP H·∫†NG</h2>
        <ul id="lb-list" class="lb-list"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- C·∫§U H√åNH C·ª¶A B·∫†N ƒê√É ƒê∆Ø·ª¢C T√çCH H·ª¢P ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXn3IK3Td2WyegZkU0m1hESQQSRLM1Zb8",
            authDomain: "minesweeper-a7423.firebaseapp.com",
            databaseURL: "https://minesweeper-a7423-default-rtdb.firebaseio.com",
            projectId: "minesweeper-a7423",
            storageBucket: "minesweeper-a7423.firebasestorage.app",
            messagingSenderId: "305681879682",
            appId: "1:305681879682:web:31f1a90362b20b06cbda9b",
            measurementId: "G-XBJQF7Q242"
        };

        // K·∫øt n·ªëi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL APP STATE ---
        const State = {
            user: null,
            score: 0,
            dbRef: ref(db)
        };

        // --- APP CONTROLLER ---
        window.App = {
            nav: (screen) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-' + screen).classList.add('active');
            },

            login: async () => {
                const btn = document.getElementById('btn-login');
                const msg = document.getElementById('msg-login');
                const input = document.getElementById('inp-name');
                
                // L·ªçc t√™n: Ch·ªâ l·∫•y ch·ªØ c√°i v√† s·ªë, b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói Firebase
                let name = input.value.trim().replace(/[^a-zA-Z0-9 ]/g, ""); 
                
                if (name.length < 2) return alert("T√™n qu√° ng·∫Øn!");

                btn.disabled = true;
                msg.innerText = "ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...";

                try {
                    // L·∫•y ƒëi·ªÉm t·ª´ server
                    const snapshot = await get(child(State.dbRef, `users/${name}`));
                    State.user = name;
                    State.score = snapshot.exists() ? snapshot.val() : 0;

                    App.updateUI();
                    document.getElementById('user-status').style.display = 'block';
                    App.nav('menu');
                } catch (e) {
                    console.error(e);
                    msg.innerText = "L·ªói m·∫°ng. Th·ª≠ l·∫°i sau!";
                }
                btn.disabled = false;
            },

            play: () => {
                App.nav('game');
                Game.init();
            },

            logout: () => location.reload(),

            leaderboard: async () => {
                const list = document.getElementById('lb-list');
                list.innerHTML = '<li style="padding:20px; text-align:center;">ƒêang t·∫£i...</li>';
                App.nav('leaderboard');

                try {
                    const snapshot = await get(child(State.dbRef, 'users'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        // Chuy·ªÉn object th√†nh m·∫£ng -> s·∫Øp x·∫øp gi·∫£m d·∫ßn
                        const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
                        
                        list.innerHTML = '';
                        sorted.forEach((item, index) => {
                            const isMe = item[0] === State.user;
                            list.innerHTML += `
                                <li class="lb-item ${isMe ? 'lb-me' : ''}">
                                    <span class="lb-rank">#${index + 1}</span>
                                    <span class="lb-name">${item[0]} ${isMe ? '(B·∫°n)' : ''}</span>
                                    <span class="lb-score">${item[1]}</span>
                                </li>
                            `;
                        });
                    } else {
                        list.innerHTML = '<li style="padding:20px; text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</li>';
                    }
                } catch (e) {
                    list.innerHTML = '<li style="padding:20px; text-align:center; color:red">L·ªói t·∫£i d·ªØ li·ªáu</li>';
                }
            },

            updateUI: () => {
                document.getElementById('ui-name').innerText = State.user;
                document.getElementById('ui-score').innerText = State.score;
            },

            saveWin: async () => {
                if (!State.user) return;
                State.score++;
                App.updateUI();
                // Update l√™n Firebase (ch·ªâ c·∫≠p nh·∫≠t tr∆∞·ªùng c·ªßa user ƒë√≥)
                const updates = {};
                updates['/users/' + State.user] = State.score;
                await update(State.dbRef, updates);
            }
        };

        // G·∫Øn s·ª± ki·ªán Login
        document.getElementById('btn-login').onclick = App.login;


        // --- GAME ENGINE (T·ªêI ∆ØU H√ìA) ---
        window.Game = {
            config: { w: 10, bombs: 15 }, // TƒÉng ƒë·ªô kh√≥ l√™n 15 bom cho h·∫•p d·∫´n
            data: [],
            dom: [],
            state: { over: false, first: true, flags: 0, revealed: 0, mode: 'dig', time: 0, timer: null },

            init: () => {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                Game.dom = [];
                Game.data = new Array(100).fill(0);
                
                // Reset State
                Game.state = { over: false, first: true, flags: 0, revealed: 0, mode: 'dig', time: 0, timer: null };
                
                // Reset UI
                document.getElementById('overlay-result').classList.remove('show');
                Game.updateHUD();
                clearInterval(Game.state.timer);
                document.getElementById('g-time').innerText = '0';
                Game.setMode('dig'); // Reset v·ªÅ ƒë√†o

                // Render Grid (D√πng DocumentFragment ƒë·ªÉ t·ªëi ∆∞u render 1 l·∫ßn)
                const fragment = document.createDocumentFragment();
                for(let i=0; i<100; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    // Touch start ƒë·ªÉ ph·∫£n h·ªìi nhanh h∆°n onclick tr√™n mobile
                    cell.onclick = () => Game.action(i); 
                    cell.oncontextmenu = (e) => { e.preventDefault(); Game.toggleFlag(i); };
                    fragment.appendChild(cell);
                    Game.dom.push(cell);
                }
                grid.appendChild(fragment);
            },

            setMode: (mode) => {
                Game.state.mode = mode;
                const btnDig = document.getElementById('mode-dig');
                const btnFlag = document.getElementById('mode-flag');
                
                if (mode === 'dig') {
                    btnDig.classList.add('active');
                    btnFlag.classList.remove('active');
                } else {
                    btnFlag.classList.add('active');
                    btnDig.classList.remove('active');
                }
                Game.vibrate(20);
            },

            updateHUD: () => {
                document.getElementById('g-flags').innerText = Game.config.bombs - Game.state.flags;
            },

            action: (i) => {
                if (Game.state.over) return;
                if (Game.state.mode === 'flag') Game.toggleFlag(i);
                else Game.dig(i);
            },

            toggleFlag: (i) => {
                const cell = Game.dom[i];
                if (cell.classList.contains('revealed')) return;

                if (cell.classList.contains('flagged')) {
                    cell.classList.remove('flagged');
                    cell.innerText = '';
                    Game.state.flags--;
                } else if (Game.state.flags < Game.config.bombs) {
                    cell.classList.add('flagged');
                    cell.innerText = 'üö©';
                    Game.state.flags++;
                    Game.vibrate(40);
                }
                Game.updateHUD();
            },

            dig: (i) => {
                const cell = Game.dom[i];
                if (cell.classList.contains('flagged') || cell.classList.contains('revealed')) return;

                // First Click Safe Logic
                if (Game.state.first) {
                    Game.plantBombs(i);
                    Game.state.first = false;
                    Game.state.timer = setInterval(() => {
                        Game.state.time++;
                        document.getElementById('g-time').innerText = Game.state.time;
                    }, 1000);
                }

                if (Game.data[i] === 'B') {
                    Game.gameOver(false, i);
                } else {
                    Game.reveal(i);
                    // Check Win ngay l·∫≠p t·ª©c
                    if (Game.state.revealed === 100 - Game.config.bombs) Game.gameOver(true);
                }
            },

            reveal: (i) => {
                const cell = Game.dom[i];
                if (cell.classList.contains('revealed')) return;

                cell.classList.add('revealed');
                Game.state.revealed++;
                
                const val = Game.data[i];
                if (val > 0) {
                    cell.innerText = val;
                    cell.classList.add('c' + val);
                } else {
                    // Flood Fill (ƒê·ªá quy m·ªü √¥ tr·ªëng)
                    Game.getNeighbors(i).forEach(n => Game.reveal(n));
                }
            },

            plantBombs: (safeIdx) => {
                let count = 0;
                while(count < Game.config.bombs) {
                    let rnd = Math.floor(Math.random() * 100);
                    if (rnd !== safeIdx && Game.data[rnd] !== 'B') {
                        Game.data[rnd] = 'B';
                        count++;
                    }
                }
                // T√≠nh s·ªë
                for(let i=0; i<100; i++) {
                    if(Game.data[i] === 'B') continue;
                    const bombs = Game.getNeighbors(i).filter(n => Game.data[n] === 'B').length;
                    Game.data[i] = bombs;
                }
            },

            getNeighbors: (i) => {
                const w = 10;
                const l = i%w === 0, r = i%w === w-1;
                const neighbors = [
                    !l ? i-1 : -1, !r ? i+1 : -1,
                    i-w, i+w,
                    !l ? i-w-1 : -1, !r ? i-w+1 : -1,
                    !l ? i+w-1 : -1, !r ? i+w+1 : -1
                ];
                return neighbors.filter(n => n >= 0 && n < 100);
            },

            gameOver: (win, i) => {
                Game.state.over = true;
                clearInterval(Game.state.timer);

                // Show bombs
                Game.data.forEach((val, idx) => {
                    if (val === 'B') {
                        const c = Game.dom[idx];
                        if (!c.classList.contains('flagged')) {
                            c.classList.add('revealed', 'bomb');
                            c.innerText = 'üí£';
                        }
                    }
                });

                const overlay = document.getElementById('overlay-result');
                const title = document.getElementById('res-title');
                
                if (win) {
                    title.innerText = "CHI·∫æN TH·∫ÆNG!";
                    title.style.color = "var(--accent)";
                    Game.vibrate([100, 50, 100, 50, 200]);
                    App.saveWin();
                } else {
                    title.innerText = "THUA CU·ªòC!";
                    title.style.color = "var(--danger)";
                    if (i !== undefined) Game.dom[i].style.background = "#b91c1c";
                    Game.vibrate(500);
                }
                
                setTimeout(() => overlay.classList.add('show'), 1000);
            },

            vibrate: (pattern) => {
                if (navigator.vibrate) navigator.vibrate(pattern);
            }
        };
    </script>
</body>
</html>
