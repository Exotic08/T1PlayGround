<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Minesweeper: Boss Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="config.js"></script>

    <style>
        /* CSS RI√äNG CHO CH·∫æ ƒê·ªò GI·∫¢I TR√ç */
        body { overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        #board-container {
            width: 95vw; max-width: 400px;
            aspect-ratio: 1 / 1;
            background: rgba(30, 41, 59, 0.8);
            padding: 8px; border-radius: 16px;
            margin: 0 auto; border: 1px solid rgba(255,255,255,0.15);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #grid {
            display: grid !important;
            width: 100%; height: 100%;
            gap: 3px;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
        }

        .cell {
            width: 100%; height: 100%;
            background: #334155; border-radius: 4px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-weight: 900; font-size: clamp(14px, 5vw, 22px); color: white;
            box-shadow: 0 3px 0 #1e293b; transition: transform 0.1s;
            user-select: none; position: relative;
        }
        .cell:active { transform: translateY(2px); box-shadow: none; }
        .cell.revealed { background: #1e293b; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transform: translateY(2px); border: 1px solid rgba(255,255,255,0.05); cursor: default; }
        
        /* C·ªú V√Ä BOM */
        .cell.flagged { color: #ef4444 !important; text-shadow: 0 0 5px red; }
        .cell.flagged::after { content: 'üö©'; font-size: 0.8em; }
        .cell.bomb { background: #ef4444 !important; color: white !important; box-shadow: none; animation: shake 0.4s; z-index: 2; }
        .cell.bomb::after { content: 'üí£'; }
        .cell.chord-error { animation: shake 0.2s; }
        .c1{color:#60a5fa} .c2{color:#4ade80} .c3{color:#f87171} .c4{color:#c084fc} .c5{color:#fbbf24}

        /* BOSS UI */
        .boss-bar-container { width: 95%; max-width: 400px; margin-bottom: 10px; display: none; flex-direction: column; align-items: center; }
        .boss-avatar { font-size: 3.5rem; margin-bottom: 5px; animation: float 2s infinite ease-in-out; filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.6)); }
        .hp-bar-bg { width: 100%; height: 24px; background: #1e293b; border-radius: 12px; overflow: hidden; border: 2px solid #475569; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ef4444, #f87171); transition: width 0.3s ease-out; }
        .hp-text { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size: 0.9rem; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.8); color: white; }
        
        .damage-anim { animation: shake 0.4s; border-color: #ef4444 !important; box-shadow: 0 0 20px #ef4444 !important; }
        .heal-anim { animation: pulseGreen 0.5s; border-color: #10b981 !important; box-shadow: 0 0 20px #10b981 !important; }
        @keyframes pulseGreen { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* OVERLAYS */
        #quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; backdrop-filter: blur(10px);
        }
        .quiz-question { font-size: 1.4rem; font-weight: 800; margin-bottom: 30px; color: var(--gold); line-height: 1.4; }
        .quiz-btn { width: 100%; margin: 8px 0; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); text-align: center; padding: 16px; border-radius: 16px; color: white; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .quiz-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }

        #result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98); z-index: 9999; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(20px);
        }
        #result-overlay.show { display: flex !important; }
        .result-icon { font-size: 5rem; margin-bottom: 15px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .lose-title { color: #ef4444; text-shadow: 0 0 30px rgba(239, 68, 68, 0.5); font-size: 2.5rem; font-weight: 900; margin: 0;}
        .win-title { color: #10b981; text-shadow: 0 0 30px rgba(16, 185, 129, 0.5); font-size: 2.5rem; font-weight: 900; margin: 0;}
        
        .btn-cooldown { opacity: 0.5; pointer-events: none; cursor: wait; filter: grayscale(1); }
        
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="toast" class="toast"><span>üèÜ</span><span id="toast-msg"></span></div>

    <div id="screen-game" class="screen active" style="display: flex; padding-top: 40px;">
        <div class="game-header">
            <a href="index.html" class="btn-icon" style="text-decoration: none; display: flex; align-items: center; justify-content: center;">‚¨Ö</a>
            <div style="font-weight:900; font-size:1.2rem; color:var(--gold); text-transform:uppercase;" id="level-display">M√ÄN 1</div>
            <div style="width: 40px;"></div> </div>

        <div id="boss-ui" class="boss-bar-container">
            <div class="boss-avatar">üëæ</div>
            <div class="hp-bar-bg">
                <div id="boss-hp-fill" class="hp-bar-fill"></div>
                <div class="hp-text">BOSS HP: <span id="boss-hp-text">10</span></div>
            </div>
        </div>

        <div id="info-bar" style="display: flex; gap: 15px; margin-bottom: 15px; width: 95%; max-width: 400px; justify-content: space-between;">
            <div class="stat-box" style="color:var(--danger); width:100%; justify-content:center;">üí£ <span id="mines-left">10</span></div>
            <div class="stat-box" style="color:var(--text); width:100%; justify-content:center;">M√†n <span id="lvl-num">1</span>/5</div>
        </div>

        <div id="board-container">
            <div id="grid"></div>
        </div>

        <div class="controls">
            <button id="btn-dig" class="mode-btn active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
            <button id="btn-flag" class="mode-btn flag" onclick="Game.setMode('flag')">üö© C·∫ÆM C·ªú</button>
        </div>
    </div>

    <div id="quiz-overlay">
        <div style="font-size:4rem; margin-bottom:10px">üòà</div>
        <div id="quiz-question" class="quiz-question">...</div>
        <div id="quiz-answers" style="width:100%; max-width:400px"></div>
    </div>

    <div id="result-overlay">
        <div id="res-icon" class="result-icon">üíÄ</div>
        <h1 id="res-title" class="result-title">GAME OVER</h1>
        <p id="res-desc" class="result-desc"></p>
        
        <button id="btn-next-lvl" class="btn btn-primary" onclick="Game.nextLevel()" style="display:none; width: 80%;">M√ÄN TI·∫æP THEO ‚û°Ô∏è</button>
        <button id="btn-retry-lvl" class="btn btn-primary" onclick="Game.retryLevel()" style="width: 80%;">üîÑ TH·ª¨ L·∫†I M√ÄN N√ÄY</button>
        <a href="index.html" class="btn" style="width: 80%;">V·ªÄ MENU CH√çNH</a>
    </div>

    <script>
        const MINES_PER_LEVEL = [10, 12, 14, 16, 20];
        const BOSS_MAX_HP = 10;
        const BOSS_DEFEAT_HP = 20; 

        const BOSS_QUESTIONS = [
            { q: "Ng∆∞∆°i c√≥ th√≠ch c√°i game D√≤ M√¨n n√†y kh√¥ng h·∫£?", a: [{ t: "C√≥ ch·ª©!", c: false }, { t: "Kh√¥ng h·ªÅ", c: false }, { t: "Boss ƒë·∫πp trai qu√° ƒëi üòç", c: true }, { t: "Tr·∫£ b√†n c·ªù ƒë√¢y!", c: false }] },
            { q: "T·∫°i sao ng∆∞∆°i l·∫°i c·ª© th√≠ch g·ª° bom c·ªßa ta?", a: [{ t: "V√¨ ƒëam m√™", c: false }, { t: "V√¨ Boss ƒë·ªÉ qu√™n bom m√†", c: true }, { t: "R·∫£nh qu√° kh√¥ng c√≥ g√¨ l√†m", c: false }, { t: "Tay l·ª° b·∫•m nh·∫ßm", c: false }] },
            { q: "M·∫≠t m√£ ƒë·ªÉ ta cho qua m√†n l√† g√¨?", a: [{ t: "V·ª´ng ∆°i m·ªü ra", c: false }, { t: "F5 l·∫°i trang web ƒëi", c: true }, { t: "Admin ƒë·∫πp trai", c: false }, { t: "123456", c: false }] },
            { q: "Ta s·∫Ω cho ng∆∞∆°i 1 t·ª∑ n·∫øu tha cho ta. Ng∆∞∆°i ch·ªçn g√¨?", a: [{ t: "L·∫•y lu√¥n 1 t·ª∑", c: false }, { t: "Ti·ªÅn l√† ph√π du, boss ph·∫£i ch·∫øt!", c: true }, { t: "Th√¥i ta tha cho Boss", c: false }, { t: "M∆° ƒëi c∆∞ng", c: false }] }
        ];

        window.Game = {
            level: 1, mines: 10, grid: [], dom: [], isOver: false, mode: 'dig',
            isBossLevel: false, bossHP: 10, quizIndex: 0, firstClick: true,
            
            canFlag: true, damagedMines: [], inQuiz: false,

            init: (lvl) => {
                Game.level = lvl; Game.isOver = false; Game.firstClick = true;
                Game.canFlag = true; Game.damagedMines = []; Game.inQuiz = false;
                
                if (lvl < 5) {
                    Game.mines = MINES_PER_LEVEL[lvl - 1]; Game.isBossLevel = false;
                    document.getElementById('boss-ui').style.display = 'none';
                    document.getElementById('info-bar').style.display = 'flex';
                    document.getElementById('level-display').innerText = `M√ÄN ${lvl}: LEO TH√ÅP`;
                } else {
                    Game.mines = 20; Game.isBossLevel = true; Game.bossHP = BOSS_MAX_HP;
                    document.getElementById('boss-ui').style.display = 'flex';
                    document.getElementById('info-bar').style.display = 'none';
                    document.getElementById('level-display').innerText = `BOSS: TR√ôM CU·ªêI`;
                    Game.updateBossBar();
                }

                const g = document.getElementById('grid'); 
                if(!g) return;
                g.innerHTML = '';
                document.getElementById('result-overlay').classList.remove('show');
                document.getElementById('result-overlay').style.display = 'none';
                document.getElementById('quiz-overlay').style.display = 'none';
                document.getElementById('board-container').style.opacity = '1';
                document.getElementById('board-container').style.pointerEvents = 'auto';
                document.getElementById('btn-flag').classList.remove('btn-cooldown');
                document.getElementById('btn-flag').style.opacity = "1";

                if(!Game.isBossLevel) document.getElementById('mines-left').innerText = Game.mines;
                document.getElementById('lvl-num').innerText = lvl;

                Game.grid = Array(100).fill(0); Game.dom = [];
                for(let i=0; i<100; i++){
                    const cell = document.createElement('div'); cell.className = 'cell';
                    cell.onclick = () => Game.click(i);
                    cell.oncontextmenu = (e) => { e.preventDefault(); Game.toggleFlag(i); };
                    g.appendChild(cell); Game.dom.push(cell);
                }
            },
            
            click: (i) => { 
                if(Game.isOver || Game.inQuiz) return;
                const c = Game.dom[i];
                // Chord
                if(c.classList.contains('revealed') && Game.grid[i] > 0) return Game.chord(i);
                Game.mode === 'flag' ? Game.toggleFlag(i) : Game.dig(i); 
            },

            dig: (i) => {
                const c = Game.dom[i];
                if(c.classList.contains('flagged') || c.classList.contains('revealed')) return;

                // --- B·∫¢O H·ªò T√ÇN TH·ª¶ ---
                if (Game.firstClick) {
                    Game.firstClick = false;
                    Game.plant(i, !Game.isBossLevel);
                }

                if(Game.grid[i] === 'B') { 
                    Game.end(false, i, "B·∫°n ƒë√£ d·∫´m ph·∫£i m√¨n!"); 
                } else {
                    Game.reveal(i);
                    if(!Game.isBossLevel) {
                        if(Game.dom.filter(c => c.classList.contains('revealed')).length === 100 - Game.mines) Game.end(true);
                    }
                }
            },

            reveal: (i) => {
                const c = Game.dom[i]; 
                if(c.classList.contains('revealed') || c.classList.contains('flagged')) return;
                c.classList.add('revealed'); c.classList.remove('flagged');
                
                if(Game.grid[i] > 0) { c.innerText = Game.grid[i]; c.classList.add('c'+Game.grid[i]); } 
                else {
                    const w=10, l=i%w===0, r=i%w===w-1;
                    const neighbors = [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1];
                    neighbors.forEach(n => { if(n>=0 && n<100) Game.reveal(n); });
                }
            },

            toggleFlag: (i) => {
                const c = Game.dom[i];
                if(c.classList.contains('revealed')) return;

                if(c.classList.contains('flagged')) {
                    c.classList.remove('flagged'); 
                    // X√≥a text 'üö©' ƒëi ƒë·ªÉ tr√°nh xung ƒë·ªôt n·∫øu d√πng CSS (m·∫∑c d√π ·ªü ƒë√¢y d√πng ::after nh∆∞ng x√≥a cho s·∫°ch)
                    c.innerText = ''; 
                    if(!Game.isBossLevel) {
                        const flags = document.querySelectorAll('.cell.flagged').length;
                        document.getElementById('mines-left').innerText = Math.max(0, Game.mines - flags);
                    }
                } else {
                    if(!Game.canFlag) return; 
                    
                    Game.canFlag = false;
                    const btn = document.getElementById('btn-flag');
                    btn.classList.add('btn-cooldown');
                    btn.style.opacity = "0.5";
                    setTimeout(() => {
                        Game.canFlag = true;
                        btn.classList.remove('btn-cooldown');
                        btn.style.opacity = "1";
                    }, 1000);

                    c.classList.add('flagged'); 
                    // KH√îNG D√ôNG innerText = 'üö©' v√¨ ƒë√£ c√≥ CSS ::after
                    
                    if(Game.isBossLevel) {
                        if(Game.grid[i] === 'B') {
                            if(!Game.damagedMines.includes(i)) {
                                Game.damagedMines.push(i);
                                Game.damageBoss();
                                Game.checkAmmo();
                            }
                        } else {
                            Game.healBoss();
                        }
                    } else {
                        const flags = document.querySelectorAll('.cell.flagged').length;
                        document.getElementById('mines-left').innerText = Math.max(0, Game.mines - flags);
                        if(flags === Game.mines) {
                             let correct = true;
                             for(let j=0; j<100; j++) if(Game.dom[j].classList.contains('flagged') && Game.grid[j]!=='B') correct = false;
                             if(correct) Game.end(true);
                        }
                    }
                }
            },

            healBoss: () => {
                Game.bossHP++;
                Game.updateBossBar();
                const board = document.getElementById('board-container');
                board.classList.add('heal-anim'); setTimeout(() => board.classList.remove('heal-anim'), 500);
                if(Game.bossHP >= BOSS_DEFEAT_HP) Game.end(false, null, "Boss ƒë√£ h·ªìi ph·ª•c qu√° m·∫°nh (20 HP)!");
            },

            damageBoss: () => {
                Game.bossHP--;
                Game.updateBossBar();
                const board = document.getElementById('board-container');
                board.classList.add('damage-anim'); setTimeout(() => board.classList.remove('damage-anim'), 300);

                if(Game.bossHP <= 0) {
                    if(window.App && window.App.unlockAch) window.App.unlockAch('boss_slayer'); 
                    Game.end(true, null, "BOSS ƒê√É B·ªä TI√äU DI·ªÜT!"); 
                    return;
                }
                if([8, 6, 4, 2].includes(Game.bossHP) && Game.quizIndex < BOSS_QUESTIONS.length) {
                    setTimeout(() => Game.triggerQuiz(), 600);
                }
            },

            checkAmmo: () => {
                if(Game.damagedMines.length === 20 && Game.bossHP > 0) {
                    setTimeout(() => Game.end(false, null, "B·∫°n ƒë√£ h·∫øt bom ƒë·ªÉ n√©m!"), 1000);
                }
            },

            updateBossBar: () => { 
                let displayPct = (Game.bossHP / 10) * 100;
                if(displayPct > 100) displayPct = 100;
                
                document.getElementById('boss-hp-fill').style.width = displayPct + '%'; 
                document.getElementById('boss-hp-text').innerText = Game.bossHP; 
                
                if(Game.bossHP > 10) document.getElementById('boss-hp-fill').style.background = "linear-gradient(90deg, #10b981, #34d399)";
                else document.getElementById('boss-hp-fill').style.background = "linear-gradient(90deg, #ef4444, #f87171)";
            },

            triggerQuiz: () => {
                Game.inQuiz = true;
                document.getElementById('board-container').style.opacity = '0.3'; 
                const q = BOSS_QUESTIONS[Game.quizIndex]; document.getElementById('quiz-question').innerText = q.q;
                const ac = document.getElementById('quiz-answers'); ac.innerHTML = '';
                q.a.forEach((ans, idx) => { const b = document.createElement('button'); b.className = 'quiz-btn'; b.innerText = ans.t; b.onclick = () => Game.answerQuiz(ans.c); ac.appendChild(b); });
                document.getElementById('quiz-overlay').style.display = 'flex'; 
            },

            answerQuiz: (isCorrect) => {
                document.getElementById('quiz-overlay').style.display = 'none';
                Game.inQuiz = false;
                if(isCorrect) { 
                    document.getElementById('board-container').style.opacity = '1'; 
                    Game.quizIndex++; 
                } else { Game.end(false, null, "Tr·∫£ l·ªùi sai! Boss ƒë√£ ti·ªÖn b·∫°n v·ªÅ l√†ng."); }
            },

            plant: (s, safeMode) => {
                const w=10, l=s%w===0, r=s%w===w-1;
                let safeZone = [s];
                if(safeMode) {
                    safeZone = [s, ...[!l?s-1:-1, !r?s+1:-1, s-w, s+w, !l?s-w-1:-1, !r?s-w+1:-1, !l?s+w-1:-1, !r?s+w+1:-1]];
                }
                safeZone = safeZone.filter(x=>x>=0&&x<100);

                let c = 0; 
                while(c < Game.mines) { 
                    let r = Math.floor(Math.random() * 100); 
                    if(!safeZone.includes(r) && Game.grid[r] !== 'B') { Game.grid[r] = 'B'; c++; } 
                }
                for(let i=0; i<100; i++) {
                    if(Game.grid[i] !== 'B') {
                        let total = 0; const w=10, l=i%w===0, r=i%w===w-1;
                        const neighbors = [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1];
                        neighbors.forEach(n => { if(n>=0 && n<100 && Game.grid[n]==='B') total++; });
                        Game.grid[i] = total;
                    }
                }
                // M·ªü ngay sau khi plant
                Game.reveal(s);
            },

            chord: (i) => {
                const w=10, l=i%w===0, r=i%w===w-1;
                const neighbors = [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1].filter(x=>x>=0&&x<100);
                const flags = neighbors.filter(n => Game.dom[n].classList.contains('flagged')).length;
                if(flags === Game.grid[i]) {
                    if(navigator.vibrate) navigator.vibrate(20);
                    neighbors.forEach(n => { 
                        if(!Game.dom[n].classList.contains('flagged') && !Game.dom[n].classList.contains('revealed')) Game.dig(n); 
                    });
                } else {
                    Game.dom[i].classList.add('chord-error');
                    setTimeout(() => Game.dom[i].classList.remove('chord-error'), 300);
                }
            },

            end: (win, i, customMsg) => {
                Game.isOver = true;
                const t = document.getElementById('res-title'); const d = document.getElementById('res-desc');
                const n = document.getElementById('btn-next-lvl'); const r = document.getElementById('btn-retry-lvl');
                
                if(!win) {
                    Game.dom.forEach(c => { if(c.classList.contains('flagged')) c.classList.remove('flagged'); });
                    Game.grid.forEach((v,x)=>{ if(v==='B') {Game.dom[x].classList.add('revealed','bomb'); Game.dom[x].innerText='üí£';}});
                    if(i !== undefined && i !== null) Game.dom[i].style.background = "#ef4444";
                }

                if(win) {
                    t.innerText = "CHI·∫æN TH·∫ÆNG!"; t.className = "result-title win-title";
                    d.innerText = (Game.level < 5) ? "ƒê·ªânh cao! L√™n t·∫ßng ti·∫øp theo n√†o." : (customMsg || "B·∫†N ƒê√É PH√Å ƒê·∫¢O!");
                    n.style.display = (Game.level < 5) ? 'block' : 'none'; r.style.display = 'none';
                } else {
                    t.innerText = "TH·∫§T B·∫†I!"; t.className = "result-title lose-title";
                    d.innerText = customMsg || "B·∫°n ƒë√£ d·∫´m ph·∫£i m√¨n!";
                    n.style.display = 'none'; r.style.display = 'block'; 
                }
                document.getElementById('result-overlay').style.display = 'flex';
            },
            nextLevel: () => { Game.init(Game.level + 1); },
            retryLevel: () => { Game.init(Game.level); },
            setMode: (m) => { Game.mode = m; document.getElementById('btn-dig').className = `mode-btn ${m==='dig'?'active':''}`; document.getElementById('btn-flag').className = `mode-btn flag ${m==='flag'?'active':''}`; }
        };

        // Start Level 1
        window.onload = () => Game.init(1);
    </script>
</body>
</html>
