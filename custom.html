<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Ch·∫ø ƒê·ªô T√πy Ch·ªânh</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="config.js"></script>

    <style>
        body { overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        #grid .cell { font-size: inherit !important; line-height: 1 !important; }
        
        #setup-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); transition: 0.3s;
        }
        #setup-overlay.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
        
        .setup-card {
            background: rgba(30, 41, 59, 0.9); padding: 25px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 350px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .preset-btn {
            width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.05); color: white; font-weight: bold; cursor: pointer;
            transition: 0.2s; text-align: left; padding-left: 20px;
        }
        .preset-btn:hover { background: rgba(255,255,255,0.15); transform: translateX(5px); }
        .preset-desc { font-size: 0.8rem; color: #94a3b8; font-weight: normal; }

        .custom-inputs { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        .inp-box { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #475569; border-radius: 8px; color: white; padding: 8px; text-align: center; font-weight: bold; }
        
        #board-container { overflow: auto; align-items: flex-start; }
        #grid { margin: auto; }

        #game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15,23,42,0.98); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 16px;
        }
        #game-overlay.show { display: flex !important; }
        
        /* Hi·ªáu ·ª©ng rung khi Chord sai */
        .chord-error { animation: shake 0.3s; background-color: rgba(239, 68, 68, 0.4) !important; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
    </style>
</head>
<body>
    
    <div id="toast" class="toast"><span>üèÜ</span><span id="toast-msg"></span></div>

    <div id="setup-overlay">
        <div class="setup-card">
            <h2 style="margin-top:0; color:#38bdf8">T√ôY CH·ªåN M√ÄN CH∆†I</h2>
            <button class="preset-btn" onclick="Game.start(10, 10, 10)">üê£ D·ªÑ <span class="preset-desc">(10x10 - 10 Bom)</span></button>
            <button class="preset-btn" onclick="Game.start(15, 15, 30)">üéì V·ª™A <span class="preset-desc">(15x15 - 30 Bom)</span></button>
            <button class="preset-btn" onclick="Game.start(20, 20, 60)">üî• KH√ì <span class="preset-desc">(20x20 - 60 Bom)</span></button>
            
            <div style="margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
            <div style="text-align:left; font-size:0.9rem; color:#cbd5e1; margin-bottom:5px;">üõ†Ô∏è T·ª± nh·∫≠p (Max 30x30 - 90 Bom):</div>
            <div class="custom-inputs">
                <input id="inp-w" type="number" class="inp-box" placeholder="W" value="20" min="5" max="30">
                <input id="inp-h" type="number" class="inp-box" placeholder="H" value="20" min="5" max="30">
                <input id="inp-m" type="number" class="inp-box" placeholder="üí£" value="40" min="1" max="90">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="Game.startCustom()">B·∫ÆT ƒê·∫¶U</button>
        </div>
        <a href="index.html" class="btn" style="margin-top:20px; width:auto; padding: 10px 30px;">QUAY V·ªÄ MENU</a>
    </div>

    <div id="screen-game" class="screen" style="display: flex;">
        <div class="game-header">
            <div class="btn-icon" onclick="document.getElementById('setup-overlay').classList.remove('hidden')">‚öôÔ∏è</div>
            <div id="pc-switch" class="pc-switch" style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.15);" onclick="Game.togglePC()">
                <div class="pc-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #64748b; transition: 0.3s;"></div>
                <span class="pc-text" style="font-size: 0.8rem; font-weight: 700; color: #94a3b8;">PC</span>
            </div>
        </div>

        <div style="display: flex; gap: 20px; margin-bottom: 15px; width: 95%; max-width: 380px; justify-content: space-between;">
            <div class="stat-box" style="color:#ef4444">üö© <span id="g-flags">0</span></div>
            <div class="stat-box" style="color:#fff">‚è±Ô∏è <span id="g-time">0</span></div>
        </div>

        <div id="board-container">
            <div id="grid"></div>
            <div id="game-overlay" style="display:none;">
                <h1 id="res-title" style="font-size:3rem; margin-bottom:10px; font-weight:900"></h1>
                <p id="res-desc" style="color:#cbd5e1; margin-bottom:30px; text-align:center; font-size:1.2rem"></p>
                <button id="btn-replay" class="btn btn-primary" onclick="Game.restart()" style="width:80%">CH∆†I L·∫†I</button>
                <button class="btn" onclick="document.getElementById('setup-overlay').classList.remove('hidden'); document.getElementById('game-overlay').style.display='none';" style="width:80%; margin-top:10px; background: #64748b;">CH·ªåN M√ÄN KH√ÅC</button>
                <a href="index.html" class="btn" style="width:80%">V·ªÄ MENU</a>
            </div>
        </div>

        <div id="mob-ctrl" class="controls">
            <button id="btn-dig" class="mode-btn active" onclick="Game.setMode('dig')">‚õèÔ∏è ƒê√ÄO</button>
            <button id="btn-flag" class="mode-btn flag" onclick="Game.setMode('flag')">üö© C·∫ÆM C·ªú</button>
        </div>
        <div id="pc-hint" style="display:none; color: #64748b; margin-top: 15px; font-size: 0.9rem; text-align: center;">Chu·ªôt tr√°i: ƒê√†o (Chord) | Chu·ªôt ph·∫£i: C·∫Øm c·ªù</div>
    </div>

    <script>
        const user = checkLogin();
        window.App = window.App || {};
        window.onload = function() { if(window.App.applySkin) window.App.applySkin(); };

        window.Game = {
            w: 10, h: 10, bombs: 10, grid: [], dom: [], rng: null, isOver: false, isPC: false, timer: null, time: 0, flags: 0, revealed: 0, firstClick: true, mode: 'dig',

            startCustom: () => {
                let w = parseInt(document.getElementById('inp-w').value)||10; let h = parseInt(document.getElementById('inp-h').value)||10; let m = parseInt(document.getElementById('inp-m').value)||10;
                w=Math.min(Math.max(w,5),30); h=Math.min(Math.max(h,5),30); m=Math.min(m, Math.min(90, (w*h)-1));
                Game.start(w,h,m);
            },
            start: (wi,he,mi) => { Game.w=wi; Game.h=he; Game.bombs=mi; document.getElementById('setup-overlay').classList.add('hidden'); Game.init(); },
            restart: () => { Game.init(); },

            init: () => {
                if(Game.timer) clearInterval(Game.timer);
                Game.isOver = false; Game.time = 0; Game.flags = 0; Game.revealed = 0; Game.firstClick = true; Game.rng = { next: () => Math.random() };
                const g = document.getElementById('grid'); g.innerHTML = ''; 
                
                g.style.gridTemplateColumns = `repeat(${Game.w}, 1fr)`;
                const bc = document.getElementById('board-container'); bc.style.maxWidth = Game.w > 15 ? "95vw" : "400px";
                let fontSize = 22; if (Game.w > 12) fontSize = 16; if (Game.w > 20) fontSize = 12;
                g.style.fontSize = fontSize + "px";

                document.getElementById('game-overlay').style.display = 'none'; document.getElementById('g-time').innerText = '0'; document.getElementById('g-flags').innerText = Game.bombs;
                
                const s = Game.w * Game.h; Game.grid = Array(s).fill(0); Game.dom = [];
                const frag = document.createDocumentFragment();
                for(let i=0; i<s; i++){
                    const c = document.createElement('div'); c.className = 'cell';
                    c.onclick = () => Game.click(i); c.oncontextmenu = (e) => { e.preventDefault(); Game.toggleFlag(i); };
                    frag.appendChild(c); Game.dom.push(c);
                }
                g.appendChild(frag);
            },

            // --- C·∫¨P NH·∫¨T LOGIC CLICK ƒê·ªÇ H·ªñ TR·ª¢ CHORD ---
            click: (i) => { 
                if(Game.isOver) return;
                const c = Game.dom[i];
                
                // N·∫æU √î ƒê√É M·ªû: Th·ª±c hi·ªán Chord (b·∫•t k·ªÉ ch·∫ø ƒë·ªô n√†o)
                if(c.classList.contains('revealed') && Game.grid[i] > 0) {
                    return Game.chord(i);
                }
                
                // N·∫øu √¥ ch∆∞a m·ªü: X·ª≠ l√Ω b√¨nh th∆∞·ªùng
                Game.isPC ? Game.dig(i) : (Game.mode==='flag'?Game.toggleFlag(i):Game.dig(i)); 
            },

            dig: (i) => {
                const c = Game.dom[i];
                // N·∫øu ƒë√£ m·ªü ho·∫∑c ƒë√£ c·∫Øm c·ªù th√¨ b·ªè qua (Tr·ª´ tr∆∞·ªùng h·ª£p chord g·ªçi dig v√†o √¥ ch∆∞a m·ªü)
                if(c.classList.contains('revealed') || c.classList.contains('flagged')) return;
                
                if(Game.firstClick) { Game.firstClick = false; Game.plant(i); Game.timer = setInterval(()=>{ Game.time++; document.getElementById('g-time').innerText=Game.time; }, 1000); }
                
                if(Game.grid[i]==='B') Game.end(false, i);
                else { Game.reveal(i); if(Game.revealed === (Game.w*Game.h)-Game.bombs) Game.end(true); }
            },

            reveal: (i) => {
                const c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                c.classList.add('revealed'); Game.revealed++;
                if(Game.grid[i]>0) { c.innerText = Game.grid[i]; c.classList.add('c'+Game.grid[i]); } else Game.getN(i).forEach(n => Game.reveal(n));
            },

            toggleFlag: (i) => {
                const c = Game.dom[i]; if(c.classList.contains('revealed')) return;
                if(c.classList.contains('flagged')) { c.classList.remove('flagged'); c.innerText=''; Game.flags--; }
                else if(Game.flags < Game.bombs) { c.classList.add('flagged'); c.innerText=''; Game.flags++; }
                document.getElementById('g-flags').innerText = Game.bombs - Game.flags;
            },

            // --- T√çNH NƒÇNG CHORD ---
            chord: (i) => {
                const n = Game.getN(i); // L·∫•y danh s√°ch √¥ xung quanh
                // ƒê·∫øm s·ªë c·ªù xung quanh
                const flags = n.filter(x => Game.dom[x].classList.contains('flagged')).length;
                
                // N·∫øu s·ªë c·ªù b·∫±ng s·ªë hi·ªÉn th·ªã tr√™n √¥ -> M·ªü c√°c √¥ c√≤n l·∫°i
                if(flags === Game.grid[i]) {
                    if(navigator.vibrate) navigator.vibrate(20); // Rung nh·∫π (mobile)
                    n.forEach(x => { 
                        // Ch·ªâ ƒë√†o nh·ªØng √¥ ch∆∞a c·∫Øm c·ªù v√† ch∆∞a m·ªü
                        if(!Game.dom[x].classList.contains('flagged') && !Game.dom[x].classList.contains('revealed')) {
                            Game.dig(x); 
                        }
                    });
                } else { 
                    // N·∫øu ch∆∞a ƒë·ªß c·ªù ho·∫∑c c·ªù sai -> Hi·ªáu ·ª©ng rung b√°o l·ªói
                    Game.dom[i].classList.add('chord-error'); 
                    setTimeout(() => Game.dom[i].classList.remove('chord-error'), 300); 
                }
            },

            plant: (s) => {
                let f = [s].concat(Game.getN(s)); let c=0; const z=Game.w*Game.h;
                while(c < Game.bombs) { let r = Math.floor(Game.rng.next()*z); if(!f.includes(r) && Game.grid[r]!=='B') { Game.grid[r]='B'; c++; } }
                for(let i=0; i<z; i++) if(Game.grid[i]!=='B') Game.grid[i] = Game.getN(i).filter(n=>Game.grid[n]==='B').length;
            },
            getN: (i) => { 
                const w=Game.w, z=w*Game.h, l=i%w===0, r=i%w===w-1;
                return [!l?i-1:-1, !r?i+1:-1, i-w, i+w, !l?i-w-1:-1, !r?i-w+1:-1, !l?i+w-1:-1, !r?i+w+1:-1].filter(x=>x>=0&&x<z); 
            },
            end: (w, i) => {
                Game.isOver = true; clearInterval(Game.timer);
                if(!w) { 
                    Game.grid.forEach((v,x)=>{ if(v==='B' && !Game.dom[x].classList.contains('flagged')) {Game.dom[x].classList.add('revealed','bomb'); }});
                    if(i!==null) Game.dom[i].style.background="#ef4444";
                    setTimeout(() => Game.showRes(false), 3000);
                } else Game.showRes(true);
            },
            showRes: (w) => {
                document.getElementById('res-title').innerText = w ? "CHI·∫æN TH·∫ÆNG!" : "THUA R·ªíI!";
                document.getElementById('res-title').style.color = w ? "#4ade80" : "#ef4444";
                document.getElementById('res-desc').innerText = w ? "B·∫°n qu√° ƒë·ªânh!" : "Th·ª≠ l·∫°i nh√©!";
                document.getElementById('game-overlay').style.display = 'flex';
            },
            togglePC: () => { Game.isPC = !Game.isPC; var s=document.getElementById('pc-switch'); var h=document.getElementById('pc-hint'); var m=document.getElementById('mob-ctrl'); if(Game.isPC) { s.classList.add('on'); h.style.display='block'; s.style.background='rgba(59,130,246,0.5)'; s.querySelector('.pc-dot').style.background='#10b981'; m.style.display='none'; } else { s.classList.remove('on'); h.style.display='none'; s.style.background='rgba(0,0,0,0.3)'; s.querySelector('.pc-dot').style.background='#64748b'; m.style.display='flex'; } },
            setMode: (m) => { Game.mode=m; document.getElementById('btn-dig').className='mode-btn '+(m==='dig'?'active':''); document.getElementById('btn-flag').className='mode-btn flag '+(m==='flag'?'active':''); }
        };
    </script>
</body>
</html>
